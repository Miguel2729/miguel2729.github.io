<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Home</title>
  <style>
:root {
  --bg-color: #202020;
  --text-color: #fff;
  --glass-bg: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.12);
  --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.36);
  --primary-color: #0078D7;
  --primary-glow: rgba(0, 120, 215, 0.3);
  --hover-color: rgba(255, 255, 255, 0.1);
  --transition-speed: 0.25s;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: none;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

img {
  filter: none !important;
  color-scheme: light dark;
}

#conteudoPrincipal {
  height: 100%;
  width: 100%;
}

/* LIQUID GLASS EFFECT */
.liquid-glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  border-radius: 12px;
}

/* BARRA DE TAREFAS MODERNA */
#barraTarefas {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 48px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  z-index: 1000;
  gap: 8px;
  background: var(--glass-bg);
  backdrop-filter: blur(40px) saturate(200%);
  -webkit-backdrop-filter: blur(40px) saturate(200%);
  border-top: 1px solid var(--glass-border);
  box-shadow: 0 -1px 20px rgba(0, 0, 0, 0.2);
}

#menuIniciar {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--primary-color), #9B4DFF);
  color: white;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  cursor: pointer;
  user-select: none;
  transition: all var(--transition-speed) ease;
  box-shadow: 0 4px 12px var(--primary-glow);
}

#menuIniciar:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px var(--primary-glow);
}

#appsRecentes {
  display: flex;
  gap: 6px;
  flex: 1;
  align-items: center;
  overflow-x: auto;
  padding: 0 8px;
}

#appsRecentes .icone {
  background: var(--glass-bg);
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  white-space: nowrap;
  transition: all var(--transition-speed) ease;
  border: 1px solid transparent;
  display: flex;
  align-items: center;
  gap: 6px;
  height: 36px;
}

#appsRecentes .icone:hover {
  background: var(--hover-color);
  border-color: var(--glass-border);
  transform: translateY(-2px);
}

#appsRecentes .icone img {
  width: 20px;
  height: 20px;
  object-fit: contain;
}

#appsRecentes .icone span {
  font-size: 12px;
  color: white;
}

/* PAINEL DO MENU INICIAR MODERNO */
#painelMenu {
  position: fixed;
  bottom: 60px;
  left: 16px;
  width: 640px;
  max-height: 70vh;
  border-radius: 16px;
  padding: 0;
  overflow: hidden;
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease, transform 0.25s ease;
  transform: translateY(20px);
  background: var(--glass-bg);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex;
}

#painelMenu.aberto {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

#painelMenuEsquerdo {
  width: 320px;
  padding: 20px;
  border-right: 1px solid var(--glass-border);
  overflow-y: auto;
  max-height: 70vh;
}

#painelMenuDireito {
  width: 320px;
  padding: 20px;
  overflow-y: auto;
  max-height: 70vh;
}

h3 {
  margin: 20px 0 12px 0;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: rgba(255, 255, 255, 0.7);
  border-bottom: none;
  padding-bottom: 0;
}

.icone, .botao {
  display: inline-block;
  padding: 12px 16px;
  margin: 4px 4px 0 0;
  background: var(--glass-bg);
  border-radius: 10px;
  cursor: pointer;
  user-select: none;
  text-align: center;
  font-size: 14px;
  transition: all var(--transition-speed) ease;
  border: 1px solid transparent;
}

.icone:hover, .botao:hover {
  background: var(--hover-color);
  border-color: var(--glass-border);
  transform: translateY(-2px);
}

.area {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 5px;
}

.botoes {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#painelDireito {
  margin-left: auto;
  display: flex;
  gap: 6px;
  align-items: center;
  height: 100%;
  padding: 0 8px;
}

.painelMini {
  background: transparent;
  padding: 0 12px;
  margin: 0;
  border-radius: 8px;
  font-size: 12px;
  cursor: default;
  user-select: none;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.painelMini:hover {
  background: var(--hover-color);
}

#relogio {
  font-family: 'Segoe UI', sans-serif;
  font-weight: 400;
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 80px;
  height: 100%;
}

#relogio .hora {
  font-size: 13px;
  font-weight: 500;
}

#relogio .data {
  font-size: 11px;
  opacity: 0.7;
}

#painelRecentes {
  position: fixed;
  bottom: 60px;
  right: 16px;
  padding: 16px;
  border-radius: 16px;
  display: none;
  max-width: 240px;
  max-height: 50vh;
  overflow-y: auto;
  transition: opacity 0.2s ease, transform 0.2s ease;
  opacity: 0;
  transform: translateY(10px);
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

#painelRecentes.aberto {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

#areaTrabalho {
  position: absolute;
  width: 100%;
  height: calc(100% - 48px);
  background-image: url("wallpapers/wallpaper18.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: 10;
  top: 48px;
  left: 0;
  overflow: visible;
}

.iconeDesktop {
  width: 80px;
  text-align: center;
  cursor: pointer;
  pointer-events: auto;
  user-select: none;
  -webkit-user-drag: none;
  transition: transform 0.2s ease;
  position: absolute;
  z-index: 50;
}

.iconeDesktop:hover {
  transform: scale(1.05);
}

.iconeDesktop img {
  width: 48px;
  height: 48px;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
  /* CORRE√á√ÉO: Remover background transparente que estava escondendo a imagem */
  background: transparent !important;
  border-radius: 0 !important;
  padding: 0 !important;
}

/* Estilo espec√≠fico para √≠cones da √°rea de trabalho - CORRE√á√ÉO */
.iconeDesktop span.nome-icone {
  display: block;
  margin-top: 4px;
  font-size: 11px;
  color: white;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
  background: rgba(0, 0, 0, 0.5);
  padding: 2px 4px;
  border-radius: 4px;
  backdrop-filter: blur(4px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.usuario-info {
  position: relative;
  display: flex;
  align-items: center;
  padding: 12px 20px;
  z-index: 100;
  height: 48px;
  box-sizing: border-box;
  
  /* EFEITO LIQUID GLASS INTENSO */
  background: rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(50px) saturate(200%);
  -webkit-backdrop-filter: blur(50px) saturate(200%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  
  /* Gradiente sutil para mais profundidade */
  background-image: 
    linear-gradient(
      to bottom,
      rgba(255, 255, 255, 0.08) 0%,
      rgba(255, 255, 255, 0.02) 100%
    );
  
  /* Sombra superior */
  box-shadow: 
    0 1px 0 rgba(255, 255, 255, 0.03),
    0 4px 20px rgba(0, 0, 0, 0.25);
}

.usuario-info img {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  margin-right: 12px;
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.usuario-info span {
  font-weight: 600;
  color: white;
  font-size: 16px;
}

#buscaApp {
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 16px;
  border: none;
  border-radius: 12px;
  font-size: 14px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  transition: all var(--transition-speed) ease;
  border: 1px solid transparent;
}

#buscaApp:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.15);
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px var(--primary-glow);
}

#botaoPower {
  position: absolute;
  bottom: 8px;
  right: 10px;
  cursor: pointer;
}

#botaoPower img {
  width: 32px;
  height: 32px;
  transition: transform 0.2s ease;
}

#botaoPower img:hover {
  transform: scale(1.1);
}

.popupPower {
  display: none;
  position: absolute;
  bottom: 45px;
  right: 0;
  border-radius: 12px;
  overflow: hidden;
  z-index: 999;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

.popupPower div {
  padding: 12px 16px;
  color: white;
  cursor: pointer;
  transition: background 0.2s;
}

.popupPower div:hover {
  background: var(--hover-color);
}

.menu-contextual {
  position: absolute;
  border-radius: 12px;
  z-index: 10000;
  padding: 8px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  min-width: 160px;
  display: none;
}

.menu-contextual button {
  display: block;
  width: 100%;
  background: none;
  border: none;
  text-align: left;
  padding: 10px 12px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  color: white;
  transition: background 0.2s;
}

.menu-contextual button:hover {
  background: var(--hover-color);
}

.loading-ring {
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
  margin-top: 30px;
}

.loading-ring div {
  box-sizing: border-box;
  display: block;
  position: absolute;
  width: 64px;
  height: 64px;
  margin: 8px;
  border: 8px solid var(--primary-color);
  border-radius: 50%;
  animation: loadingRing 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  border-color: var(--primary-color) transparent transparent transparent;
}

@keyframes loadingRing {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#bootAnimation {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #000428, #004e92);
  color: #00aaff;
  font-size: 5em;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: 'Segoe UI', sans-serif;
  z-index: 9999;
}

#bootLogo {
  animation: floatUp 1.8s ease-out;
  margin-bottom: 40px;
}

@keyframes floatUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.dia-evento {
  border: 2px solid var(--primary-color) !important;
  border-radius: 50% !important;
}

/* PAINEL DE CONFIGURA√á√ïES MODERNO */
#painelConfig {
  position: fixed;
  bottom: 60px;
  right: 16px;
  width: 300px;
  border-radius: 16px;
  padding: 20px;
  display: none;
  z-index: 999;
  background: var(--glass-bg);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

#verTudo {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: white;
  cursor: pointer;
  transition: all var(--transition-speed) ease;
}

#verTudo:hover {
  background: var(--hover-color);
  transform: translateY(-2px);
}

.icone {
  width: 84px;
  height: 84px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 12px;
  margin: 4px;
  text-align: center;
  background: var(--glass-bg);
  border-radius: 12px;
  transition: all var(--transition-speed) ease;
  cursor: pointer;
  user-select: none;
  border: 1px solid transparent;
}

.icone:hover {
  background: var(--hover-color);
  border-color: var(--glass-border);
  transform: translateY(-2px);
}

.icone img {
  width: 36px;
  height: 36px;
  object-fit: contain;
  margin-bottom: 8px;
  /* CORRE√á√ÉO: Garantir que √≠cones sejam vis√≠veis */
  background: transparent !important;
  filter: none !important;
}

.icone span {
  font-size: 12px;
  word-break: break-word;
  max-width: 100%;
  line-height: 1.2;
}

/* SLIDERS MODERNOS */
.oneui-slider {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: rgba(255, 255, 255, 0.1);
  outline: none;
  margin: 15px 0;
  transition: all 0.2s ease;
}

.oneui-slider:hover {
  background: rgba(255, 255, 255, 0.15);
}

.oneui-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--primary-color);
  cursor: pointer;
  border: 3px solid white;
  box-shadow: 0 4px 12px rgba(0, 120, 215, 0.4);
  transition: all 0.2s ease;
}

.oneui-slider::-webkit-slider-thumb:hover {
  transform: scale(1.15);
  box-shadow: 0 6px 20px rgba(0, 120, 215, 0.6);
}

.slider-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.9);
}

.slider-value {
  font-weight: 600;
  color: var(--primary-color);
  min-width: 30px;
  text-align: right;
}

.slider-group {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.slider-group:last-child {
  border-bottom: none;
  margin-bottom: 20px;
}

/* MENU CONTEXTUAL APPS */
.menu-contextual-app {
  position: absolute;
  border-radius: 12px;
  z-index: 10001;
  padding: 6px 0;
  min-width: 200px;
  background: var(--glass-bg);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  font-family: 'Segoe UI', sans-serif;
}

.menu-contextual-app button {
  display: block;
  width: 100%;
  background: none;
  border: none;
  text-align: left;
  padding: 10px 16px;
  font-size: 13px;
  color: white;
  cursor: pointer;
  transition: background 0.2s;
  border-radius: 0;
}

.menu-contextual-app button:hover {
  background: var(--hover-color);
}

.menu-contextual-app .separator {
  height: 1px;
  background-color: var(--glass-border);
  margin: 4px 0;
}

/* PAINEL DE ARQUIVOS */
#painelFS {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 340px;
  max-height: 70vh;
  overflow: auto;
  border-radius: 16px;
  padding: 20px;
  display: none;
  z-index: 9999;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

/* MODAL EDITOR */
#modalEditor {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(10px);
}

#modalEditor > div {
  background: var(--glass-bg);
  backdrop-filter: blur(30px) saturate(200%);
  padding: 24px;
  border-radius: 16px;
  width: 500px;
  max-width: 90%;
  color: white;
  display: flex;
  flex-direction: column;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

/* PAINEL CALEND√ÅRIO */
#painelCalendario {
  position: fixed;
  top: 100px;
  right: 20px;
  width: 300px;
  border-radius: 16px;
  padding: 20px;
  display: none;
  z-index: 9999;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

/* PAINEL CADERNO */
#painelCaderno {
  position: fixed;
  top: 100px;
  right: 340px;
  width: 320px;
  height: 320px;
  border-radius: 16px;
  padding: 20px;
  display: none;
  z-index: 9999;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

/* DEBUG MENSAGEM */
#debugMensagem {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  color: #fff;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 14px;
  z-index: 9999;
  display: none;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
}

/* ANIMA√á√ïES ADICIONAIS */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* SCROLLBAR MODERNA */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* CORRE√á√ÉO: Scrollbar espec√≠fica para pain√©is */
#painelMenuEsquerdo::-webkit-scrollbar,
#painelMenuDireito::-webkit-scrollbar {
  width: 6px;
}

#painelMenuEsquerdo::-webkit-scrollbar-track,
#painelMenuDireito::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
}

#painelMenuEsquerdo::-webkit-scrollbar-thumb,
#painelMenuDireito::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}



  </style>
</head>
<body>
<div id="bootAnimation">

<div id="bootLogo">entrando no perfil</div>

<div class="loading-ring">
  <div></div><div></div><div></div><div></div>
</div>
</div>

<div id="conteudoPrincipal" style="display: none">
<div id="areaTrabalho"></div>
<div id="usuario" class="usuario-info">
  <img id="userFoto" src="user/user_photo.jpg" alt="Foto do usu√°rio">
  <span id="userNome">Usu√°rio</span>
  <div style="margin-left: auto; display: flex; gap: 8px;">
  <button id="botaoFS" title="Explorar arquivos" style="background: none; border: none; font-size: 24px; cursor: pointer;">üìÇ</button>
  <button id="botaoCalendario" title="Abrir calend√°rio" style="background: none; border: none; font-size: 24px; cursor: pointer;">üóì</button>
  <button id="botaoCaderno" title="Caderno virtual" style="background: none; border: none; font-size: 24px; cursor: pointer;">üìí</button>
</div>
</div>
<div id="painelMenu">
  <div id="painelMenuEsquerdo">
    <input type="text" id="buscaApp" placeholder="Pesquisar aplicativos..." />
    <h3>Aplicativos</h3>
    <div id="apps" class="area"></div>
    <button id="verTudo" style="padding: 8px; margin-bottom: 10px;">Ver tudo</button>
    <div id="resultadosPesquisa" class="area" style="display: none;"></div>

    <h3>A√ß√µes</h3>
    <div class="botoes">
      <div class="botao" onclick="abrirMenu()">Menu</div>
      <div class="botao" onclick="fecharTudo()">Fechar tudo</div>
      <div class="botao" onclick="mostrarRecentes()">Recentes</div>
    </div>
  </div>

  <div id="painelMenuDireito">
    <h3 class="titulo-recentes">Recentemente usados</h3>
    <div id="appsRecentesMenu" class="area"></div>
  </div>

  <!-- Mantenha o bot√£o power com a imagem original: -->
  <div id="botaoPower">
    <img src="imgs/power.png" alt="Power">
    <div id="menuPower" class="popupPower">
      <div onclick="parent.postMessage('logoff', '*')">üö™ Sair</div>
      <div onclick="parent.postMessage('reboot', '*')">üîÑ Reiniciar</div>
      <div onclick="parent.postMessage('desligar', '*')">‚èª Desligar</div>
    </div>
  </div>
</div>
</div>
</div>
  <!-- Painel flutuante de apps recentes -->
  <div id="painelRecentes">Nenhum app recente</div>
<img id="lixeira" src="imgs/lixeira.png" style="position:fixed;bottom:80px;right:10px;width:50px;height:50px;z-index:900;" />
  <!-- Barra de tarefas -->
  <div id="barraTarefas">
    <div id="menuIniciar" onclick="alternarMenu()">‚ò∞</div>
    <div id="appsRecentes"></div>
    <div id="painelDireito">
      <div id="relogio" class="painelMini">
  <div class="hora">--:-- --</div>
  <div class="data">--/--/----</div>
</div>
      <div id="rede" class="painelMini">Rede: ...</div>
      <div id="temperatura" class="painelMini">Clima: ...</div>
      <!-- Substitua o elemento com id="menuRecentes" por: -->
<div id="menuConfig" class="painelMini" onclick="alternarConfig()">‚öôÔ∏è</div>

<!-- Atualize o conte√∫do do #painelConfig com este c√≥digo: -->
<div id="painelConfig" style="position:fixed;bottom:70px;right:10px;width:280px;background:rgba(30,30,30,0.98);color:white;padding:18px;border-radius:12px;box-shadow:0 5px 25px rgba(0,0,0,0.5);display:none;z-index:999;backdrop-filter:blur(15px);border:1px solid #444;">
  <h3 style="margin-top:0;margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px;font-size:16px;">Configura√ß√µes</h3>
  
  <div class="slider-group">
    <div class="slider-label">
      <span>üîÜ Brilho</span>
      <span id="brilhoValue" class="slider-value">80%</span>
    </div>
    <input type="range" id="controleBrilho" class="oneui-slider" min="10" max="100" value="80">
  </div>
  
  <div class="slider-group">
    <div class="slider-label">
      <span>üîä Volume</span>
      <span id="volumeValue" class="slider-value">50%</span>
    </div>
    <input type="range" id="controleVolume" class="oneui-slider" min="0" max="100" value="50">
  </div>
  
  <div style="display:flex;justify-content:space-between;margin-top:15px;">
    <button onclick="abrirCustomizacao()" style="background:#444;color:white;border:none;padding:8px 14px;border-radius:20px;cursor:pointer;font-size:13px;transition:background 0.2s;">Customiza√ß√£o</button>
    <button onclick="abrirBluetooth()" style="background:#444;color:white;border:none;padding:8px 14px;border-radius:20px;cursor:pointer;font-size:13px;transition:background 0.2s;">Bluetooth</button>
  </div>
</div>

    </div>
  </div>

<div id="menuContextual" class="menu-contextual" style="display: none;"></div>

<div id="painelFS" style="position:fixed;top:80px;right:20px;width:320px;max-height:70vh;overflow:auto;background:#111;border:1px solid #444;padding:10px;border-radius:8px;color:white;display:none;z-index:9999;font-family:sans-serif;">
 <h3 style="display:flex;align-items:center;gap:8px;">
  Arquivos virtuais
  <button id="btnNovo" title="Novo item">‚ûïÔ∏è</button>
  <button id="btnVisualizar" title="Visualizar todos (modo leitura)">üîç</button>
</h3>
  <div id="listaArquivos"></div>
</div>
</div>
<script>
// ==================== VARI√ÅVEIS GLOBAIS ====================
let userFolder = 'user/';
let menuTimeout;
let listaAplicativos = [];
let lastPointerEvent = null;
let appsRecentes = [];
let isVirtualUser = false;
let virtualUserUID = '';
const responseCallbacks = {};
let appsInstalados = [];
const APPS_INSTALADOS_KEY = "apps_instalados";

// ==================== FUN√á√ïES PRINCIPAIS ====================

function mostrarMenuContextualApp(appElement, nomeArquivo, nomeFormatado, isAppInstalado, x, y) {
  const menuExistente = document.querySelector('.menu-contextual-app');
  if (menuExistente) menuExistente.remove();

  const menu = document.createElement('div');
  menu.className = 'menu-contextual-app';
  menu.style.left = `${x}px`;
  menu.style.top = `${y}px`;

  const abrirBtn = document.createElement('button');
  abrirBtn.textContent = 'üìÇ Abrir';
  abrirBtn.onclick = () => {
    parent.postMessage(`abrir ${nomeArquivo}`, "*");
    menu.remove();
  };
  menu.appendChild(abrirBtn);

  const abrirAdminBtn = document.createElement('button');
  abrirAdminBtn.textContent = 'üõ°Ô∏è Abrir como administrador';
  abrirAdminBtn.onclick = () => {
    parent.postMessage(`abrir_admin ${nomeArquivo}`, "*");
    menu.remove();
  };
  menu.appendChild(abrirAdminBtn);

  const atalhoBtn = document.createElement('button');
  atalhoBtn.textContent = 'üìã Criar atalho';
  atalhoBtn.onclick = () => {
    criarAtalhoAreaTrabalho(nomeArquivo, nomeFormatado);
    menu.remove();
  };
  menu.appendChild(atalhoBtn);

  if (isAppInstalado) {
    const separator = document.createElement('div');
    separator.className = 'separator';
    menu.appendChild(separator);

    const desinstalarBtn = document.createElement('button');
    desinstalarBtn.textContent = 'üóëÔ∏è Desinstalar';
    desinstalarBtn.style.color = '#ff4444';
    desinstalarBtn.onclick = () => {
      if (confirm(`Deseja desinstalar "${nomeFormatado}"?`)) {
        removerApp(nomeArquivo);
        menu.remove();
      }
    };
    menu.appendChild(desinstalarBtn);
  }

  document.body.appendChild(menu);

  const fecharMenu = (e) => {
    if (!menu.contains(e.target)) {
      menu.remove();
      document.removeEventListener('click', fecharMenu);
    }
  };

  setTimeout(() => document.addEventListener('click', fecharMenu), 100);
}

function criarAtalhoAreaTrabalho(nomeArquivo, nomeFormatado) {
  const slotsOcupados = Array.from(document.querySelectorAll('.iconeDesktop'))
    .map(icone => parseInt(icone.style.top) || 0)
    .filter(top => top > 0);

  let slot = 1;
  while (slotsOcupados.includes(slot)) slot++;

  criarIcone(nomeArquivo, nomeFormatado, slot, 'app');
  salvarAtalhoUsuario(nomeArquivo, nomeFormatado, slot);
  Notificacao?.mostrar("Atalho criado", `Atalho para "${nomeFormatado}" criado na √°rea de trabalho`);
}

function salvarAtalhoUsuario(nomeArquivo, nomeFormatado, slot) {
  const atalhoData = { path: nomeArquivo, nome: nomeFormatado, slot: slot, tipo: 'app' };
  
  fetch(`${userFolder}files.json`)
    .then(response => response.json())
    .then(data => {
      if (!data.config) data.config = {};
      if (!data.config.icones_area_trabalho) data.config.icones_area_trabalho = [];
      data.config.icones_area_trabalho.push(atalhoData);
      console.log('Atalho salvo:', atalhoData);
    })
    .catch(() => {
      console.log('Criando nova estrutura de arquivos para atalhos');
    });
}

function getCustomKey(key) {
  if (isVirtualUser && virtualUserUID) return `virtual_${virtualUserUID}_${key}`;
  const folder = userFolder || 'user/';
  return `custom_${folder.replace(/\//g, '_')}_${key}`;
}

function salvarConfigVirtual(config) {
  if (!isVirtualUser || !virtualUserUID) return;
  const storage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
  storage.config = { ...storage.config, ...config };
  localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(storage));
}

function carregarConfigVirtual() {
  if (!isVirtualUser || !virtualUserUID) return null;
  const storage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`));
  return storage ? storage.config : null;
}

function salvarIconesDesktopVirtual(icones) {
  if (!isVirtualUser || !virtualUserUID) return;
  const storage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
  if (!storage.files) storage.files = {};
  storage.files.desktopIcons = icones;
  localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(storage));
}

function salvarAppsInstalados() {
  if (isVirtualUser && virtualUserUID) {
    const storage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
    if (!storage.apps) storage.apps = {};
    storage.apps.installed = appsInstalados;
    localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(storage));
  } else {
    localStorage.setItem(getCustomKey(APPS_INSTALADOS_KEY), JSON.stringify(appsInstalados));
  }
}

function getAppIconPath(appName) {
  const cleanName = appName.replace('.html', '').split('/')[0];
  const iconName = cleanName.replace(/\s+/g, '_').replace(/[^\w-]/g, '');
  const customIconPath = `icons/${iconName}.png`;
  
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(customIconPath);
    img.onerror = () => resolve('imgs/app.png');
    img.src = customIconPath;
  });
}

function isAppInstalado(nomeArquivo) {
  const nomeFormatado = nomeArquivo.endsWith('.html') ? nomeArquivo : `${nomeArquivo}.html`;
  return appsInstalados.includes(nomeFormatado);
}

async function renderizarApps() {
  const container = document.getElementById("apps");
  container.innerHTML = "";
  const appsToShow = listaAplicativos.slice(0, 8);
  
  for (const nomeArquivo of appsToShow) {
    const nomeFormatado = formatarNomeApp(nomeArquivo);
    const icone = await criarElementoIcone(nomeArquivo, nomeFormatado);
    container.appendChild(icone);
  }
}

function atualizarListaAplicativos() {
  fetch("apps.json")
    .then(resp => resp.json())
    .then(appsPadrao => {
      listaAplicativos = [...new Set([...appsPadrao, ...appsInstalados])];
      renderizarApps();
    })
    .catch(() => {
      listaAplicativos = [...appsInstalados];
      renderizarApps();
    });
}

function formatarNomeApp(nomeArquivo) {
  return nomeArquivo.replace(".html", "").split("/")[0].replace(/_/g, ' ');
}

async function criarElementoIcone(nomeArquivo, nomeFormatado) {
  const icone = document.createElement("div");
  icone.className = "icone";
  const isAppInstalado = appsInstalados.includes(nomeArquivo);

  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.flexDirection = "column";
  container.style.alignItems = "center";
  container.style.justifyContent = "center";
  container.style.width = "100%";
  container.style.height = "100%";
  container.style.cursor = "pointer";

  const img = document.createElement("img");
  img.src = await getAppIconPath(nomeArquivo);
  img.style.width = "32px";
  img.style.height = "32px";
  img.style.objectFit = "contain";
  img.style.marginBottom = "5px";

  const nomeSpan = document.createElement("span");
  nomeSpan.textContent = nomeFormatado;
  nomeSpan.style.fontSize = "12px";
  nomeSpan.style.textAlign = "center";
  nomeSpan.style.wordBreak = "break-word";
  nomeSpan.style.maxWidth = "70px";

  container.appendChild(img);
  container.appendChild(nomeSpan);
  icone.appendChild(container);

  icone.onclick = () => perguntarModoAbertura(nomeArquivo);
  icone.oncontextmenu = (e) => {
    e.preventDefault();
    e.stopPropagation();
    mostrarMenuContextualApp(icone, nomeArquivo, nomeFormatado, isAppInstalado, e.clientX, e.clientY);
  };

  return icone;
}

function instalarApp(nomeArquivo) {
  const nomeFormatado = nomeArquivo.endsWith('.html') ? nomeArquivo : `${nomeArquivo}.html`;
  if (!appsInstalados.includes(nomeFormatado)) {
    appsInstalados.push(nomeFormatado);
    salvarAppsInstalados();
    atualizarListaAplicativos();
    console.log(`‚úÖ App instalado: ${nomeFormatado}`);
  }
}

function removerApp(nomeArquivo) {
  const nomeFormatado = nomeArquivo.endsWith('.html') ? nomeArquivo : `${nomeArquivo}.html`;
  appsInstalados = appsInstalados.filter(app => app !== nomeFormatado);
  salvarAppsInstalados();
  atualizarListaAplicativos();
  console.log(`‚ùå App removido: ${nomeFormatado}`);
  parent.postMessage(`fechar ${nomeArquivo}`, `*`);
}

function recarregarAppsPadrao() {
  fetch("apps.json")
    .then(resp => resp.json())
    .then(appsPadrao => {
      listaAplicativos = [...new Set([...appsPadrao, ...appsInstalados])];
      atualizarListaAplicativos();
    })
    .catch(() => {
      listaAplicativos = [...appsInstalados];
      atualizarListaAplicativos();
    });
}

function criarUsuarioVirtual(nome, fotoBase64) {
  virtualUserUID = 'v_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
  
  const userData = {
    name: nome,
    photo: `data:image/jpg;base64,${fotoBase64}`,
    createdAt: new Date().toISOString(),
    uid: virtualUserUID
  };
  
  const userStorage = {
    config: {
      wallpaper: 'wallpaper18.png',
      theme: 'escuro',
      taskbarColor: 'rgba(20, 20, 20, 0.95)',
      showTopBar: true,
      showDateTime: true,
      showNetwork: true,
      showWeather: true,
      showRecentApps: true,
      showSearchBar: true
    },
    files: {
      structure: { "/": { "apps": { tipo: "pasta", conteudo: {} }, "documentos": { tipo: "pasta", conteudo: {} } } },
      desktopIcons: []
    },
    apps: { installed: [], recent: [] },
    notes: "",
    calendarEvents: {}
  };
  
  localStorage.setItem(`virtual_user_${virtualUserUID}`, JSON.stringify(userData));
  localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(userStorage));
  isVirtualUser = true;
  carregarDadosUsuario();
  carregarConfiguracoes();
  criarIconesPadraoVirtual();
  console.log(`‚úÖ Usu√°rio virtual criado: ${nome} (UID: ${virtualUserUID})`);
}

function criarIconesPadraoVirtual() {
  const iconesPadrao = [
    { path: "/apps/", nome: "Apps", slot: 1, tipo: "pasta" },
    { path: "/documentos/", nome: "Documentos", slot: 2, tipo: "pasta" },
    { path: "/documentos/notas.txt", nome: "notas.txt", slot: 3, tipo: "arquivo" }
  ];
  
  iconesPadrao.forEach(icone => criarIcone(icone.path, icone.nome, icone.slot, icone.tipo));
  salvarIconesDesktopVirtual(iconesPadrao);
}

function abrirVisualizadorComRetry(path, tentativas = 0) {
  const maxTentativas = 3;
  const delay = 1000;
  
  parent.postMessage("abrir_admin visualizador_de_arquivos.html", "*");
  
  setTimeout(() => {
    const visualizador = encontrarJanelaApp("visualizador_de_arquivos.html");
    if (visualizador && visualizador.contentWindow) {
      visualizador.contentWindow.postMessage(`f2 abrir_arquivo ${path}`, "*");
    } else if (tentativas < maxTentativas) {
      console.log(`Tentativa ${tentativas + 1} - Visualizador n√£o est√° pronto, tentando novamente...`);
      abrirVisualizadorComRetry(path, tentativas + 1);
    } else {
      console.error("Visualizador n√£o respondeu ap√≥s v√°rias tentativas");
    }
  }, delay);
}

function carregarEstruturaArquivos() {
  fetch(`${userFolder}files.json`)
    .then(response => response.json())
    .then(data => {
      document.querySelectorAll('.iconeDesktop').forEach(icone => icone.remove());
      if (data.config && data.config.icones_area_trabalho) {
        data.config.icones_area_trabalho.forEach(item => {
          const nome = item.path.split('/').pop();
          criarIcone(item.path, nome, item.slot, item.path.endsWith('/') ? 'pasta' : 'arquivo');
        });
      }
    })
    .catch(error => {
      console.error("Erro ao carregar files.json:", error);
      criarIconesPadrao();
    });
}

function criarIconesPadrao() {
  const iconesPadrao = [
    { path: "/apps/", nome: "Apps", slot: 1, tipo: "pasta" },
    { path: "/documentos/", nome: "Documentos", slot: 2, tipo: "pasta" },
    { path: "/documentos/notas.txt", nome: "notas.txt", slot: 3, tipo: "arquivo" }
  ];
  iconesPadrao.forEach(icone => criarIcone(icone.path, icone.nome, icone.slot, icone.tipo));
}

function moverIcone(icone) {
  console.log("Movendo √≠cone:", icone.dataset.nome);
}

function criarSubpasta(iconePasta) {
  const nome = prompt("Nome da nova subpasta:");
  if (nome) {
    const caminhoPai = iconePasta.dataset.path;
    const novoCaminho = `${caminhoPai}/${nome}`;
    window.FileSystem.criarPasta(nome, caminhoPai);
    const novoSlot = Math.floor(Math.random() * 20) + 1;
    criarIcone(novoCaminho, nome, novoSlot, "pasta");
  }
}

function mostrarPropriedades(icone) {
  const props = {
    "Nome": icone.dataset.nome,
    "Tipo": icone.dataset.tipo,
    "Caminho": icone.dataset.path,
    "Tamanho": icone.dataset.tamanho || "N/A",
    "Criado em": icone.dataset.criado || new Date().toLocaleString()
  };
  
  let msg = "";
  for (const [key, value] of Object.entries(props)) msg += `${key}: ${value}\n`;
  alert(msg);
}

function abrirItem(icone) {
  if (icone._opening) return;
  icone._opening = true;
  
  const tipo = icone.dataset.tipo;
  const nome = icone.dataset.nome;
  const caminho = icone.dataset.path;

  switch(tipo) {
    case "pasta":
      const visualizadorExistente = encontrarJanelaApp("visualizador_de_arquivos.html");
      if (visualizadorExistente) {
        visualizadorExistente.contentWindow.postMessage(`f2 abrir_arquivo ${caminho}`, "*");
        visualizadorExistente.parentElement.style.zIndex = 999999;
      } else {
        parent.postMessage("abrir visualizador_de_arquivos.html", "*");
        setTimeout(() => {
          const visualizador = encontrarJanelaApp("visualizador_de_arquivos.html");
          if (visualizador) visualizador.contentWindow.postMessage(`f2 abrir_arquivo ${caminho}`, "*");
        }, 500);
      }
      break;
    case "app":
      parent.postMessage(`abrir ${caminho}`, "*");
      break;
    default:
      parent.postMessage(`abrir visualizador_de_arquivos.html?file=${encodeURIComponent(caminho)}`, "*");
  }
  
  setTimeout(() => icone._opening = false, 1000);
}

function encontrarJanelaApp(nomeApp) {
  try {
    const iframes = Array.from(document.querySelectorAll(".janela iframe"));
    return iframes.find(iframe => {
      try { return iframe.src.includes(nomeApp); } catch { return false; }
    });
  } catch { return null; }
}

const getBoolSetting = (key, defaultValue = true) => {
  const value = localStorage.getItem(getCustomKey(key));
  return value === null ? defaultValue : value === "true";
};

function resetarConfiguracoesPadrao() {
  const padroes = {
    "showTopBar": "true",
    "taskbarColor": "rgba(20, 20, 20, 0.95)",
    "showDateTime": "true",
    "showNetwork": "true",
    "showWeather": "true",
    "theme": "escuro",
    "showRecentApps": "true",
    "showSearchBar": "true",
    "font": ""
  };
  
  for (const [key, value] of Object.entries(padroes)) localStorage.setItem(getCustomKey(key), value);
  carregarConfiguracoes();
  Notificacao?.mostrar("Configura√ß√µes", "Configura√ß√µes resetadas para os valores padr√£o");
}

function carregarConfiguracoes() {
  document.getElementById("usuario").style.display = getBoolSetting("showTopBar") ? "flex" : "none";
  
  const taskbarColor = localStorage.getItem(getCustomKey("taskbarColor"));
  if (taskbarColor) document.getElementById("barraTarefas").style.background = taskbarColor;
  
  document.getElementById("relogio").style.display = getBoolSetting("showDateTime", true) ? "block" : "none";
  document.getElementById("rede").style.display = getBoolSetting("showNetwork", true) ? "block" : "none";
  document.getElementById("temperatura").style.display = getBoolSetting("showWeather", true) ? "block" : "none";
  document.getElementById("painelMenuDireito").style.display = getBoolSetting("showRecentApps", true) ? "block" : "none";
  
  const buscaAppContainer = document.getElementById("buscaApp").parentNode;
  buscaAppContainer.style.display = getBoolSetting("showSearchBar", true) ? "block" : "none";
  
  const theme = localStorage.getItem(getCustomKey("theme"));
  if (theme === "claro") {
    document.documentElement.style.setProperty('--bg-color', '#f0f0f0');
    document.documentElement.style.setProperty('--text-color', '#333');
  } else {
    document.documentElement.style.setProperty('--bg-color', '#202020');
    document.documentElement.style.setProperty('--text-color', '#fff');
  }
}

function aplicarConfiguracoesVirtual(config) {
  if (!config) return;
  
  if (config.showTopBar !== undefined) {
    document.getElementById("usuario").style.display = config.showTopBar ? "flex" : "none";
    localStorage.setItem(getCustomKey("showTopBar"), config.showTopBar ? "true" : "false");
  }
  
  if (config.taskbarColor) {
    document.getElementById("barraTarefas").style.background = config.taskbarColor;
    localStorage.setItem(getCustomKey("taskbarColor"), config.taskbarColor);
  }
  
  if (config.showDateTime !== undefined) {
    document.getElementById("relogio").style.display = config.showDateTime ? "block" : "none";
    localStorage.setItem(getCustomKey("showDateTime"), config.showDateTime ? "true" : "false");
  }
  
  if (config.theme === "claro") {
    document.documentElement.style.setProperty('--bg-color', '#f0f0f0');
    document.documentElement.style.setProperty('--text-color', '#333');
    localStorage.setItem(getCustomKey("theme"), "claro");
  }
}

function carregarDadosUsuario() {
  if (isVirtualUser && virtualUserUID) {
    const virtualUserData = JSON.parse(localStorage.getItem(`virtual_user_${virtualUserUID}`));
    const virtualStorage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`));
    
    if (virtualUserData) {
      document.getElementById("userNome").textContent = virtualUserData.name || "Usu√°rio Virtual";
      document.getElementById("userFoto").src = virtualUserData.photo || "user/user_photo.jpg";
    }
    
    if (virtualStorage) {
      if (virtualStorage.config) aplicarConfiguracoesVirtual(virtualStorage.config);
      if (virtualStorage.apps && virtualStorage.apps.installed) appsInstalados = virtualStorage.apps.installed;
      if (virtualStorage.files && virtualStorage.files.desktopIcons) {
        virtualStorage.files.desktopIcons.forEach(icone => {
          criarIcone(icone.path, icone.nome, icone.slot, icone.tipo);
        });
      }
      if (virtualStorage.notes) localStorage.setItem(getCustomKey("notas"), virtualStorage.notes);
      if (virtualStorage.calendarEvents) {
        Object.entries(virtualStorage.calendarEvents).forEach(([key, value]) => {
          localStorage.setItem(getCustomKey(`eventos_${key}`), JSON.stringify(value));
        });
      }
    }
  } else {
    fetch(`${userFolder}user_name.txt`)
      .then(res => res.ok ? res.text() : Promise.reject())
      .then(texto => {
        document.getElementById("userNome").textContent = texto.trim() || "Convidado";
        document.getElementById("userFoto").src = `${userFolder}user_photo.jpg`;
      })
      .catch(() => {
        document.getElementById("userNome").textContent = "Convidado";
        document.getElementById("userFoto").src = "user/user_photo.jpg";
      });
  }
  
  const area = document.getElementById("areaTrabalho");
  const wallpaperSalvo = getUserWallpaper();
  if (wallpaperSalvo) area.style.backgroundImage = `url("wallpapers/${wallpaperSalvo}")`;
  else {
    area.style.backgroundImage = 'url("wallpapers/wallpaper18.png")';
    setUserWallpaper('wallpaper18.png');
  }
}

function iniciarToqueLongo(target, tipo, x, y) {
  target._lastX = x;
  target._lastY = y;
  menuTimeout = setTimeout(() => mostrarMenuContextual(target, tipo, x, y), 600);
}

function cancelarToqueLongo() {
  clearTimeout(menuTimeout);
}

const barra = [];

function alternarMenu() {
  const painel = document.getElementById("painelMenu");
  painel.classList.toggle("aberto");
}

async function criarBotaoRecente(nome) {
  const area = document.getElementById("appsRecentes");
  if (barra.includes(nome)) return;

  barra.push(nome);
  const nomeFormatado = formatarNomeApp(nome);
  const icone = await criarElementoIcone(nome, nomeFormatado);
  
  icone.style.flexDirection = "row";
  icone.style.alignItems = "center";
  icone.style.padding = "5px 10px";
  icone.querySelector("img").style.marginRight = "5px";
  icone.querySelector("img").style.marginBottom = "0";
  icone.querySelector("span").style.fontSize = "11px";
  
  icone.onclick = () => {
    parent.postMessage("recents " + nome, "*");
    icone.remove();
    const index = barra.indexOf(nome);
    if (index !== -1) barra.splice(index, 1);
  };

  area.appendChild(icone);
}

function abrirMenu() {
  parent.postMessage("abrir menu.html", "*");
}

function fecharTudo() {
  parent.postMessage("fechar_tudo", "*");
}

function mostrarRecentes() {
  barra.forEach(nome => parent.postMessage("recents " + nome, "*"));
}

function alternarRecentes() {
  const painel = document.getElementById("painelRecentes");
  painel.classList.toggle("aberto");
  painel.innerHTML = barra.length ? barra.map(nome => `<div class="icone">${nome}</div>`).join("") : "Nenhum app recente";
}

// ==================== EVENT LISTENERS ====================

window.addEventListener("message", (e) => {
  const debug = document.getElementById("debugMensagem");
  debug.textContent = "Recebido: " + e.data;
  debug.style.display = "block";
  clearTimeout(debug._timer);
  debug._timer = setTimeout(() => debug.style.display = "none", 3000);

  if (e.data.startsWith("recents ")) {
    const nome = e.data.split(" ")[1];
    criarBotaoRecente(nome);
  }
  
  if (e.data.startsWith("user:")) {
    userFolder = `users/${e.data.split(':')[1].trim()}/`;
    document.getElementById("userFoto").src = `${userFolder}user_photo.jpg`;
    carregarDadosUsuario();
    carregarConfiguracoes();
    fetch(`${userFolder}files.json`)
      .then(response => response.json())
      .then(data => atualizarAreaTrabalho(data))
      .catch(criarIconesPadrao);
  }
  
  if (e.data.startsWith("custom-user:")) {
    const parts = e.data.split(' ');
    const photoPart = parts.find(p => p.startsWith('photo='));
    const namePart = parts.find(p => p.startsWith('name='));
    const photoBase64 = photoPart ? photoPart.split('=')[1] : '';
    const name = namePart ? decodeURIComponent(namePart.split('=')[1]) : 'Usu√°rio Virtual';
    
    criarUsuarioVirtual(name, photoBase64);
    document.getElementById("bootAnimation").style.display = "none";
    document.getElementById("conteudoPrincipal").style.display = "block";
    criarIconesPadrao();
    return;
  }
  
  if (e.data.startsWith("install ")) {
    const nomeArquivo = e.data.substring(8);
    instalarApp(nomeArquivo);
  } 
  else if (e.data.startsWith("delapp ")) {
    const nomeArquivo = e.data.substring(7);
    removerApp(nomeArquivo);
  }
  
  if (e.data.startsWith("notificar_app_aberto ")) {
    const nomeArquivo = e.data.split(" ")[1];
    const nomeFormatado = nomeArquivo.replace(".html", "");
    
    fetch("apps_using_user_data.json")
      .then(response => response.json())
      .then(appsComAcesso => {
        if (appsComAcesso.includes(nomeFormatado)) {
          const pastaUsuario = userFolder.replace('users/', '').replace(/\//g, '');
          parent.postMessage(`abrir ${nomeArquivo}`, "*");
          setTimeout(() => {
            const janelaApp = encontrarJanelaApp(nomeArquivo);
            if (janelaApp && janelaApp.contentWindow) {
              janelaApp.contentWindow.postMessage(`user: ${pastaUsuario}`, "*");
            }
          }, 1000);
        } else {
          parent.postMessage(`abrir ${nomeArquivo}`, "*");
        }
      })
      .catch(() => parent.postMessage(`abrir ${nomeArquivo}`, "*"));
  }
  
  const wallpaperSalvo = getUserWallpaper();
  if (wallpaperSalvo) {
    const area = document.getElementById("areaTrabalho");
    area.style.backgroundImage = `url("wallpapers/${wallpaperSalvo}")`;
  }

  if (e.data.startsWith("w ")) {
    const nomeWallpaper = e.data.split(" ")[1];
    const area = document.getElementById("areaTrabalho");
    if (area) {
      area.style.backgroundImage = `url("wallpapers/${nomeWallpaper}")`;
      setUserWallpaper(nomeWallpaper);
      debug.textContent = "Wallpaper aplicado: " + nomeWallpaper;
    }
  }

  if (e.data.startsWith("f1 ")) {
    const [cmd, ...args] = e.data.split(" ").slice(1);
    switch(cmd) {
      case "atualizar_icones": atualizarIconesAreaTrabalho(); break;
      case "novo_arquivo": criarNovoArquivo(args[0], args[1]); break;
    }
  }

  if (e.data.startsWith("light ")) {
    const valorStr = e.data.split(" ")[1];
    const porcentagem = parseInt(valorStr);
    if (!isNaN(porcentagem)) {
      const brilho = Math.max(0.1, porcentagem / 100);
      document.documentElement.style.filter = `brightness(${brilho})`;
      debug.textContent = `üîÜ Brilho para ${porcentagem}%`;
    }
  }
  
  if (typeof e.data === 'string' && e.data.startsWith('p ')) {
    const [prefix, type, ...data] = e.data.substring(2).split(' ');
    for (const id in responseCallbacks) {
      if (responseCallbacks[id].type === type) {
        responseCallbacks[id].resolve(data[0]);
        delete responseCallbacks[id];
        break;
      }
    }
  }
  
  // CORRE√á√ÉO CR√çTICA: SWITCH-CASE CORRIGIDO
  if (e.data.startsWith("custom ")) {
    const parts = e.data.split(" ");
    const command = parts[1];
    const value = parts.slice(2).join(" ");

    switch(command) {
      case "superiorbarra":
        localStorage.setItem(getCustomKey("showTopBar"), value === "sim" ? "true" : "false");
        document.getElementById("usuario").style.display = value === "sim" ? "flex" : "none";
        if (isVirtualUser) setTimeout(salvarEstadoUsuarioVirtual, 100);
        break;

      case "padrao":
        resetarConfiguracoesPadrao();
        if (isVirtualUser) setTimeout(salvarEstadoUsuarioVirtual, 100);
        break;
 
      case "barra":
        if (parts[2] === "cor") {
          const cor = parts[3];
          localStorage.setItem(getCustomKey("taskbarColor"), cor);
          document.getElementById("barraTarefas").style.background = cor;
        } else {
          const mostrar = parts[3] === "sim";
          let settingKey, element;

          switch(parts[2]) {
            case "dataehora":
              settingKey = "showDateTime";
              element = document.getElementById("relogio");
              break;
            case "net":
              settingKey = "showNetwork";
              element = document.getElementById("rede");
              break;
            case "clima":
              settingKey = "showWeather";
              element = document.getElementById("temperatura");
              break;
            default:
              return;
          }

          localStorage.setItem(getCustomKey(settingKey), mostrar ? "true" : "false");
          element.style.display = mostrar ? "block" : "none";
        }
        if (isVirtualUser) setTimeout(salvarEstadoUsuarioVirtual, 100);
        break;

      case "menuIniciar":
        const mostrarMenu = parts[3] === "sim";
        let settingKeyMenu, elementMenu;

        if (parts[2] === "recentes") {
          settingKeyMenu = "showRecentApps";
          elementMenu = document.getElementById("painelMenuDireito");
        } else if (parts[2] === "barra") {
          settingKeyMenu = "showSearchBar";
          elementMenu = document.getElementById("buscaApp").parentNode;
        } else return;

        localStorage.setItem(getCustomKey(settingKeyMenu), mostrarMenu ? "true" : "false");
        elementMenu.style.display = mostrarMenu ? "block" : "none";
        if (isVirtualUser) setTimeout(salvarEstadoUsuarioVirtual, 100);
        break;
        
      case "tema":
        localStorage.setItem(getCustomKey("theme"), value);
        if (value === "claro") {
          document.documentElement.style.setProperty('--bg-color', '#f0f0f0');
          document.documentElement.style.setProperty('--text-color', '#333');
        } else {
          document.documentElement.style.setProperty('--bg-color', '#202020');
          document.documentElement.style.setProperty('--text-color', '#fff');
        }
        if (isVirtualUser) setTimeout(salvarEstadoUsuarioVirtual, 100);
        break;
        
      case "font":
        localStorage.setItem(getCustomKey("font"), value);
        const fontLink = document.createElement('link');
        fontLink.href = value;
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);
        if (isVirtualUser) setTimeout(salvarEstadoUsuarioVirtual, 100);
        break;
    }
  }
});

// ==================== FUN√á√ïES RESTANTES ====================

function atualizarIconesAreaTrabalho() {
  document.querySelectorAll(".iconeDesktop").forEach(icone => icone.remove());
  percorrerEstrutura(window.FileSystem.estrutura["/"]);
}

function percorrerEstrutura(estrutura, caminho = "/") {
  for (const [nome, dados] of Object.entries(estrutura)) {
    if (dados.tipo === "pasta") {
      criarIcone(`${caminho}${nome}`, nome, 1, "pasta", dados);
      if (dados.conteudo) percorrerEstrutura(dados.conteudo, `${caminho}${nome}/`);
    } else {
      criarIcone(`${caminho}${nome}`, nome, 1, dados.tipo, dados);
    }
  }
}

function carregarTodosAplicativos() {
  return new Promise((resolve) => {
    fetch("apps.json")
      .then(resp => resp.json())
      .then(appsPadrao => {
        const instaladosSalvos = localStorage.getItem(getCustomKey(APPS_INSTALADOS_KEY));
        appsInstalados = instaladosSalvos ? JSON.parse(instaladosSalvos) : [];
        listaAplicativos = [...new Set([...appsPadrao, ...appsInstalados])];
        resolve();
      })
      .catch(error => {
        console.error("Erro ao carregar apps padr√£o:", error);
        listaAplicativos = [...appsInstalados];
        resolve();
      });
  });
}

function formatarHoraWindows() {
  const agora = new Date();
  let horas = agora.getHours();
  const ampm = horas >= 12 ? 'PM' : 'AM';
  horas = horas % 12;
  horas = horas ? horas : 12;
  const minutos = agora.getMinutes().toString().padStart(2, '0');
  return `${horas}:${minutos} ${ampm}`;
}

function formatarDataWindows() {
  const agora = new Date();
  const dia = agora.getDate().toString().padStart(2, '0');
  const mes = (agora.getMonth() + 1).toString().padStart(2, '0');
  const ano = agora.getFullYear();
  return `${dia}/${mes}/${ano}`;
}

function atualizarRelogio() {
  const relogio = document.getElementById("relogio");
  if (!relogio) return;
  relogio.querySelector('.hora').textContent = formatarHoraWindows();
  relogio.querySelector('.data').textContent = formatarDataWindows();
  relogio.onmouseenter = () => {
    const agora = new Date();
    const diaSemana = agora.toLocaleDateString('pt-BR', { weekday: 'long' });
    relogio.title = `${diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1)}`;
  };
}

setInterval(atualizarRelogio, 1000);
atualizarRelogio();

function atualizarRede() {
  const online = navigator.onLine ? "Online" : "Offline";
  const nomeRede = "Wi-Fi";
  document.getElementById("rede").textContent = `Rede: ${nomeRede} (${online})`;
}

window.addEventListener("online", atualizarRede);
window.addEventListener("offline", atualizarRede);
atualizarRede();

async function perguntarModoAbertura(nomeArquivo) {
  adicionarAppRecente(nomeArquivo);
  const nomeFormatado = nomeArquivo.replace(".html", "");
  const userFolder = window.userFolder || 'user/';
  const userId = userFolder.replace('users/', '').replace(/\//g, '');
  
  const [parentalEnabled, isSupervised, isBlocked, remainingTime] = await Promise.all([
    waitForResponse('parentalControlResponse', "p check parental-control enabled"),
    waitForResponse('supervisionResponse', `p check ${userId} supervision`),
    waitForResponse('blockResponse', `p check ${userId} app-blocked ${nomeFormatado}`),
    waitForResponse('timeResponse', `p check ${userId} time`)
  ]);

  if (parentalEnabled === 'true' && isSupervised === 'true') {
    if (isBlocked === 'true') {
      alert('Este aplicativo est√° bloqueado pelo controle parental.');
      return;
    }
    if (parseInt(remainingTime) <= 0) {
      alert('Voc√™ atingiu seu limite di√°rio de uso.');
      return;
    }
    parent.postMessage(`p startTimer ${userId} ${nomeFormatado}`, "*");
  }

  parent.postMessage("abrir dialogo.html", "*");
  setTimeout(() => {
    const dadosDialogo = {
      type: "quiz",
      msg: `Como deseja abrir ${nomeFormatado.replace(/_/g, ' ')}?`,
      button1: [
        `parent.postMessage("abrir ${nomeArquivo}", "*");
         parent.postMessage("p logApp ${userId} ${nomeFormatado} normal", "*")`,
        "Modo Seguro"
      ],
      button2: [
        `parent.postMessage("abrir_admin ${nomeArquivo}", "*");
         parent.postMessage("p logApp ${userId} ${nomeFormatado} admin", "*")`,
        "Administrador"
      ]
    };
    parent.postMessage("dialog " + JSON.stringify(dadosDialogo), "*");
  }, 300);
}

function waitForResponse(type, messageToSend = null) {
  return new Promise((resolve) => {
    const id = Math.random().toString(36).substr(2, 9);
    responseCallbacks[id] = { type, resolve };
    if (messageToSend) parent.postMessage(messageToSend, "*");
    setTimeout(() => {
      if (responseCallbacks[id]) {
        delete responseCallbacks[id];
        resolve('false');
      }
    }, 200);
  });
}

function getSlotPosition(slot) {
  const coluna = (slot - 1) % 8;
  const linha = Math.floor((slot - 1) / 8);
  return { left: 10 + coluna * 90, top: 10 + linha * 110 };
}

function criarIcone(caminho, nome, slot, tipo, metadata = {}) {
  const icone = document.createElement("div");
  icone.className = "iconeDesktop";
  icone.draggable = true;
  
  let iconImg;
  switch(tipo) {
    case "pasta": iconImg = "imgs/folder.png"; break;
    case "texto": iconImg = "imgs/file_text.png"; break;
    case "imagem": iconImg = "imgs/file_image.png"; break;
    case "audio": iconImg = "imgs/file_audio.png"; break;
    case "app":
      if (caminho.endsWith('.html')) {
        const cleanName = caminho.replace('.html', '').split('/')[0];
        const iconName = cleanName.replace(/\s+/g, '_').replace(/[^\w-]/g, '');
        iconImg = `icons/${iconName}.png`;
      } else iconImg = "imgs/file_app.png";
      break;
    default: iconImg = "imgs/file.png";
  }

  icone.innerHTML = `<img src="${iconImg}" alt="${tipo}"><br><span class="nome-icone">${nome}</span>`;
  icone.dataset.path = caminho;
  icone.dataset.tipo = tipo;
  icone.dataset.nome = nome;
  Object.entries(metadata).forEach(([key, value]) => icone.dataset[key] = value);

  const img = icone.querySelector("img");
  img.addEventListener("contextmenu", e => e.preventDefault());
  icone.addEventListener("dblclick", () => abrirItem(icone));
  icone.addEventListener("pointerdown", (e) => iniciarToqueLongo(icone, tipo, e.clientX, e.clientY));

  const pos = getSlotPosition(Number(slot));
  icone.style.left = pos.left + "px";
  icone.style.top = pos.top + "px";
  document.getElementById("areaTrabalho").appendChild(icone);
  return icone;
}

const area = document.getElementById("areaTrabalho");
area.addEventListener("dragover", e => e.preventDefault());
area.addEventListener("drop", e => {
  e.preventDefault();
  try {
    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    if (!data) return;
    const icone = document.querySelector(`[data-path="${data.path}"]`);
    if (icone) {
      icone.style.left = (e.clientX - 40) + "px";
      icone.style.top = (e.clientY - 40) + "px";
    }
  } catch (error) {
    console.error("Erro ao processar drop:", error);
  }
});

area.addEventListener("pointerdown", (e) => {
  if (e.target === area) iniciarToqueLongo(area, "vazio", e.clientX, e.clientY);
});
area.addEventListener("pointerup", cancelarToqueLongo);
area.addEventListener("pointerleave", cancelarToqueLongo);

fetch(`${userFolder}files.json`)
  .then(resp => resp.json())
  .then(json => {
    (json.pastas || []).forEach(([path, slot]) => {
      const nome = path.split("/").pop();
      criarIcone(path, nome, slot, "folder");
    });
    (json.arquivos || []).forEach(([path, slot]) => {
      const nome = path.split("/").pop();
      criarIcone(path, nome, slot, "file");
    });
  })
  .catch(() => console.log("N√£o foi poss√≠vel carregar files.json"));

const lixeira = document.getElementById("lixeira");
lixeira.addEventListener("dragover", e => e.preventDefault());
lixeira.addEventListener("drop", e => {
  e.preventDefault();
  try {
    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    if (!data) return;
    const icone = document.querySelector(`[data-path="${data.path}"]`);
    if (icone && confirm(`Deseja mover "${data.nome}" para a lixeira?`)) icone.remove();
  } catch (error) {
    console.error("Erro ao processar drop na lixeira:", error);
  }
});

fetch(`${userFolder}user_name.txt`)
  .then(res => res.ok ? res.text() : Promise.reject())
  .then(texto => {
    document.getElementById("userNome").textContent = texto.trim() || "Convidado";
    document.getElementById("userFoto").src = `${userFolder}user_photo.jpg`;
  })
  .catch(() => {
    document.getElementById("userNome").textContent = "Convidado";
    document.getElementById("userFoto").src = "user/user_photo.jpg";
  });

document.getElementById("botaoPower").addEventListener("click", () => {
  const menu = document.getElementById("menuPower");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
});

function mostrarMenuContextual(target, tipo, x, y) {
  const menu = document.getElementById("menuContextual");
  menu.innerHTML = "";
  
  criarOpcao(menu, "Renomear", () => renomearIcone(target));
  criarOpcao(menu, "Mover", () => moverIcone(target));

  if (tipo === "pasta") {
    criarOpcao(menu, "Abrir", () => abrirItem(target));
    criarOpcao(menu, "Nova subpasta", () => criarSubpasta(target));
  } else if (tipo === "app") {
    criarOpcao(menu, "Executar", () => abrirItem(target));
    criarOpcao(menu, "Propriedades", () => mostrarPropriedades(target));
  } else {
    criarOpcao(menu, "Abrir com", () => abrirItem(target));
    criarOpcao(menu, "Visualizar", () => visualizarArquivo(target));
  }

  criarOpcao(menu, "Excluir", () => excluirItem(target));
  menu.style.left = `${x}px`;
  menu.style.top = `${y}px`;
  menu.style.display = "block";
}

function criarOpcao(container, texto, callback) {
  const botao = document.createElement("button");
  botao.textContent = texto;
  botao.onclick = (e) => {
    e.stopPropagation();
    container.style.display = "none";
    callback();
  };
  container.appendChild(botao);
}

document.addEventListener("pointerdown", (e) => lastPointerEvent = e);

function isFirstTimeUser() {
  if (isVirtualUser) return !localStorage.getItem(`virtual_user_first_time_${virtualUserUID}`);
  const firstTimeKey = `first_time_${userFolder.replace(/\//g, '_')}`;
  return localStorage.getItem(firstTimeKey) === null;
}

function markUserAsNotFirstTime() {
  if (isVirtualUser) localStorage.setItem(`virtual_user_first_time_${virtualUserUID}`, '1');
  else {
    const firstTimeKey = `first_time_${userFolder.replace(/\//g, '_')}`;
    localStorage.setItem(firstTimeKey, '1');
  }
}

setTimeout(() => {
  try {
    document.getElementById("bootAnimation").style.display = "none";
    document.getElementById("conteudoPrincipal").style.display = "block";
    
    const instaladosSalvos = localStorage.getItem(getCustomKey(APPS_INSTALADOS_KEY));
    appsInstalados = instaladosSalvos ? JSON.parse(instaladosSalvos) : [];
    
    carregarTodosAplicativos().then(() => {
      const wallpaperSalvo = getUserWallpaper();
      const areaTrabalho = document.getElementById("areaTrabalho");
      areaTrabalho.style.backgroundImage = wallpaperSalvo ? `url("wallpapers/${wallpaperSalvo}")` : 'url("wallpapers/wallpaper18.png")';

      fetch(`${userFolder}files.json`)
        .then(response => response.json())
        .then(data => atualizarAreaTrabalho(data))
        .catch(criarIconesPadrao);

      carregarConfiguracoes();
      carregarDadosUsuario();

      if (isFirstTimeUser()) {
        parent.postMessage("abrir_admin bem-vindo.html", "*");
        markUserAsNotFirstTime();
      }

      atualizarRelogio();
      atualizarRede();
    }).catch(error => console.error("Erro ao carregar apps:", error));

  } catch (error) {
    console.error("Erro durante o boot:", error);
    document.getElementById("bootAnimation")?.remove();
    document.getElementById("conteudoPrincipal").style.display = "block";
    setTimeout(() => location.reload(), 2000);
  }
}, 7000);

const btnFS = document.getElementById("botaoFS");
const painelFS = document.getElementById("painelFS");
const lista = document.getElementById("listaArquivos");

btnFS.addEventListener("click", () => {
  painelFS.style.display = painelFS.style.display === "none" ? "block" : "none";
  renderizarArquivos();
});

function renderizarArquivos() {
  lista.innerHTML = "";
  const estrutura = window.FileSystem?.estrutura?.["/"];
  if (!estrutura) {
    lista.innerHTML = "<em>Nenhum arquivo dispon√≠vel</em>";
    return;
  }

  for (const nome in estrutura) {
    const item = estrutura[nome];
    const tipo = item.bin ? "üìÑ" : "??";
    const div = document.createElement("div");
    div.style.padding = "4px 0";
    div.style.borderBottom = "1px solid #333";
    div.innerHTML = `${tipo} ${nome} `;

    if (item.bin) {
      const btnEditar = document.createElement("button");
      btnEditar.textContent = "‚úèÔ∏è";
      btnEditar.style.marginLeft = "10px";
      btnEditar.onclick = () => abrirEditor(nome, item.bin);
      div.appendChild(btnEditar);
    }
    lista.appendChild(div);
  }
}

let arquivoAtual = null;

function abrirEditor(nome, conteudo) {
  arquivoAtual = nome;
  document.getElementById("editorTitulo").textContent = `üìù Editando: ${nome}`;
  document.getElementById("editorConteudo").value = conteudo;
  document.getElementById("modalEditor").style.display = "flex";
}

document.getElementById("btnNovo").addEventListener("click", () => {
  const nome = prompt("Nome do novo item:");
  if (!nome) return;
  const tipo = confirm("Criar como arquivo bin√°rio (OK) ou pasta (Cancelar)?");
  if (tipo) {
    const conteudo = prompt("Conte√∫do inicial (texto):") ?? "";
    FileSystem.criarArquivo(nome, conteudo);
    Notificacao?.mostrar("Arquivo criado", `Criado "${nome}" com conte√∫do.`);
  } else {
    FileSystem.criarPasta(nome);
    Notificacao?.mostrar("Pasta criada", `Criada pasta "${nome}".`);
  }
  renderizarArquivos();
});

document.getElementById("btnVisualizar").addEventListener("click", () => {
  const estrutura = FileSystem.estrutura?.["/"];
  if (!estrutura) return alert("Nenhum conte√∫do para exibir.");
  let texto = "üìÅ Visualiza√ß√£o da raiz:\n\n";
  for (const nome in estrutura) {
    const item = estrutura[nome];
    texto += item.bin ? `üìÑ ${nome} ‚Üí ${item.bin.slice(0, 100)}\n` : `üìÅ ${nome}\n`;
  }
  alert(texto);
});

function fecharEditor() {
  document.getElementById("modalEditor").style.display = "none";
  arquivoAtual = null;
}

function salvarArquivoEditado() {
  const novoConteudo = document.getElementById("editorConteudo").value;
  if (!arquivoAtual || !window.FileSystem?.estrutura?.["/"][arquivoAtual]) return;
  window.FileSystem.estrutura["/"][arquivoAtual].bin = novoConteudo;
  fecharEditor();
  renderizarArquivos();
  Notificacao?.mostrar("Arquivo salvo", `Altera√ß√µes em "${arquivoAtual}" foram salvas.`);
}

document.getElementById("botaoCalendario").addEventListener("click", () => {
  const painel = document.getElementById("painelCalendario");
  painel.style.display = painel.style.display === "none" ? "block" : "none";
  gerarCalendario(new Date());
});

document.getElementById("botaoCaderno").addEventListener("click", () => {
  const painel = document.getElementById("painelCaderno");
  const texto = document.getElementById("cadernoTexto");
  painel.style.display = painel.style.display === "block" ? "none" : "block";
  texto.value = localStorage.getItem("notas") || "";
});

function salvarCaderno() {
  const texto = document.getElementById("cadernoTexto").value;
  localStorage.setItem("notas", texto);
  Notificacao?.mostrar("Caderno", "Notas salvas com sucesso!");
}

function gerarCalendario(dataRef) {
  const corpo = document.getElementById("corpoCalendario");
  const titulo = document.getElementById("tituloMes");
  const mes = dataRef.getMonth();
  const ano = dataRef.getFullYear();
  const dataInicio = new Date(ano, mes, 1);
  const diaSemanaInicio = dataInicio.getDay();
  const diasNoMes = new Date(ano, mes + 1, 0).getDate();
  const hoje = new Date();

  titulo.textContent = dataRef.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
  corpo.innerHTML = "";
  let linha = document.createElement("tr");
  for (let i = 0; i < diaSemanaInicio; i++) linha.appendChild(document.createElement("td"));

  const eventosKey = `eventos_${userFolder.replace(/\//g, '_')}_${ano}_${mes}`;
  const eventos = JSON.parse(localStorage.getItem(eventosKey)) || {};

  for (let dia = 1; dia <= diasNoMes; dia++) {
    if (linha.children.length === 7) {
      corpo.appendChild(linha);
      linha = document.createElement("tr");
    }
    const td = document.createElement("td");
    td.textContent = dia;
    td.style.padding = "6px";
    td.style.cursor = "pointer";

    if (dia === hoje.getDate() && mes === hoje.getMonth() && ano === hoje.getFullYear()) {
      td.style.background = "#0078D7";
      td.style.color = "white";
      td.style.borderRadius = "50%";
    }
    
    if (eventos[dia]) {
      td.classList.add("dia-evento");
      td.title = `Evento: ${eventos[dia]}`;
    }

    td.addEventListener("click", () => {
      if (dia !== hoje.getDate() || mes !== hoje.getMonth() || ano !== hoje.getFullYear()) {
        const nomeEvento = prompt(`Digite o nome do evento para ${dia}/${mes + 1}/${ano}:`, eventos[dia] || "");
        if (nomeEvento !== null) {
          if (nomeEvento) {
            eventos[dia] = nomeEvento;
            td.classList.add("dia-evento");
            td.title = `Evento: ${nomeEvento}`;
          } else {
            delete eventos[dia];
            td.classList.remove("dia-evento");
            td.title = "";
          }
          localStorage.setItem(eventosKey, JSON.stringify(eventos));
        }
      }
    });
    linha.appendChild(td);
  }

  if (linha.children.length > 0) {
    while (linha.children.length < 7) linha.appendChild(document.createElement("td"));
    corpo.appendChild(linha);
  }
  verificarEventosHoje();
}

function verificarEventosHoje() {
  const hoje = new Date();
  const dia = hoje.getDate();
  const mes = hoje.getMonth();
  const ano = hoje.getFullYear();
  const eventosKey = `eventos_${userFolder.replace(/\//g, '_')}_${ano}_${mes}`;
  const eventos = JSON.parse(localStorage.getItem(eventosKey)) || {};
  if (eventos[dia]) alert(`evento hoje, Voc√™ tem um evento marcado: ${eventos[dia]}`);
}
async function mostrarTodosAplicativos() {
  const botao = document.getElementById("verTudo");
  const container = document.getElementById("apps");
  const resultadosPesquisa = document.getElementById("resultadosPesquisa");
  
  // Se o bot√£o diz "Ocultar", volte para a visualiza√ß√£o normal
  if (botao.textContent === "Ocultar") {
    // Voltar para visualiza√ß√£o normal (8 primeiros apps)
    container.innerHTML = "";
    container.style.display = "flex";
    container.style.flexWrap = "wrap";
    container.style.gap = "6px";
    resultadosPesquisa.style.display = "none";
    
    // Mostrar apenas os primeiros 8 apps
    const appsParaMostrar = listaAplicativos.slice(0, 8);
    for (const nomeArquivo of appsParaMostrar) {
      const nomeFormatado = formatarNomeApp(nomeArquivo);
      const icone = await criarElementoIcone(nomeArquivo, nomeFormatado);
      container.appendChild(icone);
    }
    
    botao.textContent = "Ver tudo";
    return;
  }
  
  // Se chegou aqui, √© para mostrar TODOS os apps
  // PRIMEIRO: garantir que temos apps carregados
  if (!listaAplicativos || listaAplicativos.length === 0) {
    // Tenta carregar os apps agora
    const response = await fetch("apps.json");
    const appsDoArquivo = await response.json();
    
    // Pega apps instalados
    const appsInstaladosSalvos = localStorage.getItem(getCustomKey(APPS_INSTALADOS_KEY));
    const appsInstaladosLocais = appsInstaladosSalvos ? JSON.parse(appsInstaladosSalvos) : [];
    
    // Junta tudo
    listaAplicativos = [...new Set([...appsDoArquivo, ...appsInstaladosLocais])];
  }
  
  // Limpar container
  container.innerHTML = "";
  container.style.display = "flex";
  container.style.flexWrap = "wrap";
  container.style.gap = "8px";
  resultadosPesquisa.style.display = "none";
  
  // Mostrar TODOS os apps
  for (const nomeArquivo of listaAplicativos) {
    const nomeFormatado = formatarNomeApp(nomeArquivo);
    const icone = await criarElementoIcone(nomeArquivo, nomeFormatado);
    container.appendChild(icone);
  }
  
  botao.textContent = "Ocultar";
}

async function pesquisarAplicativos() {
  const termo = document.getElementById("buscaApp").value.toLowerCase();
  if (!termo) {
    document.getElementById("apps").style.display = "block";
    document.getElementById("resultadosPesquisa").style.display = "none";
    return;
  }

  const resultados = listaAplicativos.filter(app => app.replace('.html', '').toLowerCase().includes(termo));
  const container = document.getElementById("resultadosPesquisa");
  container.innerHTML = "";
  
  if (resultados.length === 0) {
    container.innerHTML = '<em>Nenhum app encontrado</em>';
  } else {
    for (const nomeArquivo of resultados) {
      const nomeFormatado = formatarNomeApp(nomeArquivo);
      const icone = await criarElementoIcone(nomeArquivo, nomeFormatado);
      container.appendChild(icone);
    }
  }

  document.getElementById("apps").style.display = "none";
  container.style.display = "grid";
  container.style.gridTemplateColumns = "repeat(auto-fill, minmax(80px, 1fr))";
  container.style.gap = "8px";
}

function criarBotaoApp(nomeArquivo) {
  const nome = nomeArquivo.replace('.html', '').replace(/_/g, ' ');
  return `<div class="icone" onclick="perguntarModoAbertura('${nomeArquivo}')">${nome}</div>`;
}

function renomearIcone(target) {
  const nomeAntigo = target.querySelector(".nome-icone")?.textContent || target.textContent.trim();
  const img = target.querySelector("img");
  const input = document.createElement("input");
  input.type = "text";
  input.value = nomeAntigo;
  input.style.width = "70px";
  input.style.textAlign = "center";
  input.style.background = "#333";
  input.style.color = "white";
  input.style.border = "none";

  const nomeSpan = target.querySelector(".nome-icone") || document.createElement("span");
  nomeSpan.className = "nome-icone";
  nomeSpan.style.display = "none";
  target.appendChild(nomeSpan);
  target.innerHTML = "";
  target.appendChild(img);
  target.appendChild(document.createElement("br"));
  target.appendChild(input);
  input.focus();

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const novoNome = input.value.trim();
      if (novoNome) {
        target.innerHTML = "";
        target.appendChild(img);
        target.innerHTML += "<br>";
        const novoNomeSpan = document.createElement("span");
        novoNomeSpan.className = "nome-icone";
        novoNomeSpan.textContent = novoNome;
        target.appendChild(novoNomeSpan);
        target.dataset.nome = novoNome;
      }
    }
  });

  input.addEventListener("blur", () => {
    const novoNome = input.value.trim();
    if (novoNome) {
      target.innerHTML = "";
      target.appendChild(img);
      target.innerHTML += "<br>";
      const novoNomeSpan = document.createElement("span");
      novoNomeSpan.className = "nome-icone";
      novoNomeSpan.textContent = novoNome;
      target.appendChild(novoNomeSpan);
      target.dataset.nome = novoNome;
    }
  });
}

function getWallpaperKey() {
  return `wallpaper_${userFolder.replace(/\//g, '_')}`;
}

function getUserWallpaper() {
  const wallpaperKey = getCustomKey("wallpaper");
  const savedWallpaper = localStorage.getItem(wallpaperKey);
  if (savedWallpaper) return savedWallpaper;
  if (isVirtualUser) return null;
  try {
    return 'wallpaper18.png';
  } catch (e) {
    console.warn("Wallpaper padr√£o n√£o encontrado, usando fallback");
    return 'wallpaper18.png';
  }
}

function setUserWallpaper(wallpaper) {
  if (!wallpaper) return;
  const wallpaperKey = getCustomKey("wallpaper");
  
  if (isVirtualUser && wallpaper.startsWith('data:image')) {
    const virtualStorage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
    if (!virtualStorage.config) virtualStorage.config = {};
    virtualStorage.config.wallpaperData = wallpaper;
    virtualStorage.config.wallpaper = 'custom_wallpaper.jpg';
    localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(virtualStorage));
    localStorage.setItem(wallpaperKey, 'custom_wallpaper.jpg');
  } else {
    localStorage.setItem(wallpaperKey, wallpaper);
    if (isVirtualUser && virtualUserUID) {
      const virtualStorage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
      if (!virtualStorage.config) virtualStorage.config = {};
      virtualStorage.config.wallpaper = wallpaper;
      localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(virtualStorage));
    }
  }
  
  const area = document.getElementById("areaTrabalho");
  if (wallpaper.startsWith('data:image')) area.style.backgroundImage = `url("${wallpaper}")`;
  else area.style.backgroundImage = `url("wallpapers/${wallpaper}")`;
}

function alternarConfig() {
  const painel = document.getElementById("painelConfig");
  painel.style.display = painel.style.display === "block" ? "none" : "block";
  document.getElementById("painelRecentes").style.display = "none";
  document.getElementById("painelMenu").classList.remove("aberto");
}

function abrirCustomizacao() {
  parent.postMessage("abrir customizacao.html", "*");
}

function abrirBluetooth() {
  parent.postMessage("abrir bluetooth.html", "*");
}

document.getElementById("controleBrilho").addEventListener("input", (e) => {
  parent.postMessage(`light ${e.target.value}%`, "*");
});

document.getElementById("controleVolume").addEventListener("input", (e) => {
  parent.postMessage(`volume ${e.target.value}%`, "*");
});

function adicionarAppRecente(nomeArquivo) {
  appsRecentes = appsRecentes.filter(app => app !== nomeArquivo);
  appsRecentes.unshift(nomeArquivo);
  if (appsRecentes.length > 10) appsRecentes = appsRecentes.slice(0, 10);
  localStorage.setItem(`appsRecentes_${userFolder.replace(/\//g, '_')}`, JSON.stringify(appsRecentes));
  atualizarAppsRecentesMenu();
}

function carregarAppsRecentes() {
  const salvos = localStorage.getItem(`appsRecentes_${userFolder.replace(/\//g, '_')}`);
  if (salvos) {
    appsRecentes = JSON.parse(salvos);
    atualizarAppsRecentesMenu();
  }
}

async function atualizarAppsRecentesMenu() {
  const container = document.getElementById("appsRecentesMenu");
  container.innerHTML = "";
  if (appsRecentes.length === 0) {
    container.innerHTML = "<em>Nenhum app usado recentemente</em>";
    return;
  }
  
  for (const nomeArquivo of appsRecentes) {
    const nomeFormatado = formatarNomeApp(nomeArquivo);
    const icone = await criarElementoIcone(nomeArquivo, nomeFormatado);
    container.appendChild(icone);
  }
  
  container.style.display = "grid";
  container.style.gridTemplateColumns = "repeat(auto-fill, minmax(80px, 1fr))";
  container.style.gap = "8px";
}

window.addEventListener('load', carregarAppsRecentes);
document.getElementById("buscaApp").addEventListener("input", pesquisarAplicativos);
document.getElementById("verTudo").addEventListener("click", mostrarTodosAplicativos);

function atualizarAreaTrabalho(data) {
  document.querySelectorAll('.iconeDesktop').forEach(icone => icone.remove());
  if (data.config && data.config.icones_area_trabalho) {
    data.config.icones_area_trabalho.forEach(item => {
      const nome = item.nome || item.path.split('/').pop();
      criarIcone(item.path, nome, item.slot || 1, item.tipo || (item.path.endsWith('/') ? 'pasta' : 'arquivo'));
    });
  } else criarIconesPadrao();
}

function salvarAppsInstaladosVirtual(apps) {
  if (!isVirtualUser || !virtualUserUID) return;
  const storage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
  if (!storage.apps) storage.apps = {};
  storage.apps.installed = apps;
  localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(storage));
}

function listarUsuariosVirtuais() {
  const usuarios = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('virtual_user_')) {
      const uid = key.replace('virtual_user_', '');
      const userData = JSON.parse(localStorage.getItem(key));
      usuarios.push({ uid: uid, name: userData.name, photo: userData.photo, createdAt: userData.createdAt });
    }
  }
  return usuarios;
}

function entrarUsuarioVirtual(uid) {
  virtualUserUID = uid;
  isVirtualUser = true;
  carregarDadosUsuario();
  carregarConfiguracoes();
  document.getElementById("bootAnimation").style.display = "none";
  document.getElementById("conteudoPrincipal").style.display = "block";
  console.log(`üë§ Entrou no usu√°rio virtual: ${virtualUserUID}`);
}

function excluirUsuarioVirtual(uid) {
  const keysToRemove = [
    `virtual_user_${uid}`, `virtual_storage_${uid}`,
    `virtual_user_first_time_${uid}`, `virtual_wallpaper_data_${uid}`
  ];
  
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(`virtual_${uid}_`)) keysToRemove.push(key);
  }
  
  keysToRemove.forEach(key => localStorage.removeItem(key));
  console.log(`üóëÔ∏è Usu√°rio virtual ${uid} exclu√≠do`);
}

function salvarEstadoUsuarioVirtual() {
  if (!isVirtualUser || !virtualUserUID) return;
  const virtualStorage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`)) || {};
  if (!virtualStorage.config) virtualStorage.config = {};
  
  const configKeys = ['showTopBar', 'taskbarColor', 'showDateTime', 'showNetwork', 'showWeather', 'theme', 'showRecentApps', 'showSearchBar'];
  configKeys.forEach(key => {
    const value = localStorage.getItem(getCustomKey(key));
    if (value !== null) virtualStorage.config[key] = key.includes('show') ? (value === 'true') : value;
  });
  
  if (!virtualStorage.apps) virtualStorage.apps = {};
  virtualStorage.apps.installed = appsInstalados;
  virtualStorage.apps.recent = appsRecentes;
  virtualStorage.notes = localStorage.getItem(getCustomKey("notas")) || "";
  
  const hoje = new Date();
  const mesKey = `${hoje.getFullYear()}_${hoje.getMonth()}`;
  const eventos = JSON.parse(localStorage.getItem(getCustomKey(`eventos_${mesKey}`))) || {};
  virtualStorage.calendarEvents = {};
  virtualStorage.calendarEvents[mesKey] = eventos;
  
  localStorage.setItem(`virtual_storage_${virtualUserUID}`, JSON.stringify(virtualStorage));
  console.log(`üíæ Estado do usu√°rio ${virtualUserUID} salvo`);
}

setInterval(salvarEstadoUsuarioVirtual, 30000);
window.addEventListener('beforeunload', salvarEstadoUsuarioVirtual);

function carregarAppsInstaladosVirtual() {
  if (!isVirtualUser || !virtualUserUID) return [];
  const storage = JSON.parse(localStorage.getItem(`virtual_storage_${virtualUserUID}`));
  return storage && storage.apps ? storage.apps.installed : [];
}

// Garantir que a lista de apps seja carregada quando a p√°gina carrega
window.addEventListener('load', function() {
  // Carrega os apps ap√≥s 1 segundo (tempo para tudo inicializar)
  setTimeout(async function() {
    if (!listaAplicativos || listaAplicativos.length === 0) {
      try {
        const response = await fetch("apps.json");
        const appsDoArquivo = await response.json();
        
        const appsInstaladosSalvos = localStorage.getItem(getCustomKey(APPS_INSTALADOS_KEY));
        const appsInstaladosLocais = appsInstaladosSalvos ? JSON.parse(appsInstaladosSalvos) : [];
        
        listaAplicativos = [...new Set([...appsDoArquivo, ...appsInstaladosLocais])];
        console.log("Apps carregados no carregamento da p√°gina:", listaAplicativos.length);
      } catch (error) {
        console.error("Erro ao carregar apps:", error);
      }
    }
  }, 1000);
});
</script>
<div id="modalEditor" style="position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:10000;">
  <div style="background:#111; padding:20px; border-radius:10px; width:500px; max-width:90%; color:white; display:flex; flex-direction:column;">
    <h3 id="editorTitulo">Editar arquivo</h3>
    <textarea id="editorConteudo" style="flex:1; min-height:200px; margin-top:10px; background:#222; color:#fff; border:none; padding:10px; font-family:monospace;"></textarea>
    <div style="margin-top:10px; display:flex; justify-content:space-between;">
      <button onclick="salvarArquivoEditado()" style="padding:8px 14px;">üíæ Salvar</button>
      <button onclick="fecharEditor()" style="padding:8px 14px;">‚ùå Cancelar</button>
    </div>
  </div>
</div>

<div id="painelCalendario" style="position:fixed;top:100px;right:20px;width:280px;background:#111;color:white;border:1px solid #444;border-radius:10px;padding:10px;display:none;z-index:9999;font-family:sans-serif;">
  <div id="tituloMes" style="text-align:center;font-weight:bold;margin-bottom:10px;"></div>
  <table style="width:100%;border-collapse:collapse;text-align:center;">
    <thead>
      <tr style="color:#aaa;">
        <th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>S√°b</th>
      </tr>
    </thead>
    <tbody id="corpoCalendario"></tbody>
  </table>
</div>

<div id="painelCaderno" style="position:fixed; top:100px; right:320px; width:300px; height:300px; background:#111; color:white; border:1px solid #444; border-radius:10px; padding:10px; display:none; z-index:9999; font-family:sans-serif;">
  <h3 style="margin-top:0;">Caderno virtual</h3>
  <textarea id="cadernoTexto" style="width:100%;height:80%;background:#222;color:#fff;border:none;padding:8px;font-family:monospace;"></textarea>
  <button onclick="salvarCaderno()" style="margin-top:8px;">üíæ Salvar</button>
</div>

<div id="debugMensagem" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;z-index:9999;display:none;"></div>


</body>
</html>
