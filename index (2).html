<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>desktop virtual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
html, body {
  background-color: black;
  background-image: url('files/wallpaper.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

body {
  margin: 0;
  background: #202020;
  font-family: sans-serif;
  overflow: hidden;
}

img {
  filter: none !important;
  color-scheme: light dark;
}

iframe#homeIframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  border: none;
  display: block;
  z-index: 10;
}

#areaDeTrabalho {
  position: relative;
  width: 100%;
  height: calc(100vh - 250px);
  overflow: hidden;
  z-index: 5;
}

.janela {
  position: fixed;
  width: 600px;
  height: 400px;
  background: #2c2c2c;
  border: 2px solid #444;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 999999;
  border-radius: 20px;
}

.barra {
  background: #333;
  color: white;
  padding: 6px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  user-select: none;
  touch-action: none;
  border-radius: 8px;
}

.titulo {
  font-size: 14px;
  flex: 1;
}

.icones {
  display: flex;
  gap: 6px;
}

.icones img {
  width: 24px;
  height: 24px;
  cursor: pointer;
}

.conteudo {
  flex: 1;
  overflow: hidden;
}

.conteudo iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.alca-resize {
  position: absolute;
  width: 20px;
  height: 20px;
  right: 0;
  bottom: 0;
  background: #555;
  cursor: nwse-resize;
  touch-action: none;
  z-index: 1;
}

#notificacao {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-family: sans-serif;
  z-index: 9999;
  display: none;
  pointer-events: none;
}
#hudVolume {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: 300px;
  height: 20px;
  background-color: black;
  border: 2px solid #000;
  border-radius: 6px;
  display: none;
  z-index: 999999999;
}

#hudVolume .barra {
  height: 100%;
  background-color: blue;
  border-radius: 4px;
  width: 50%; /* Volume inicial: 50% */
  transition: width 0.2s ease;
}
  </style>
</head>
<body>

<div id="areaDeTrabalho"></div>
<iframe id="homeIframe" src="logon.html"></iframe>
<div id="notificacao" style="/* mesmo estilo... */"></div>
<div id="hudVolume">
  <div class="barra"></div>
</div>
<script>

function verificarCompatibilidadeAmbiente() {
  const host = window.location.hostname;
  const userAgent = navigator.userAgent.toLowerCase();
  const isReplit = host.includes("replit") || userAgent.includes("replit");

  // Atalho global para saber se estamos no modo compatível
  window.MODO_COMPATIVEL = isReplit;

  if (MODO_COMPATIVEL) {
    console.warn("⚠️ Modo de compatibilidade Replit ativado");

    // Opcional: sobrescrever fatalError para evitar BSOD
    window.fatalError = function (motivo = 0) {
      const mensagens = {
        1: "ERR.JS.GLOBAL.ERROR",
        2: "ERR.HOMEIFRAME.NOT.EXIST.DOM",
        3: "ERR.IFRAME.NATIVE.ERROR",
        4: "ERR.HOME.NOT.LOADED",
        5: "ERR.CONFLIT",
        6: "ERR.FUNCTION.OVERLOADED",
        default: "ERR.UNKNOWN"
      };

      const erro = mensagens[motivo] || mensagens.default;
      console.warn(`(Compatível) [${erro}] - Ignorado para evitar BSOD`);
    };
  }
}

verificarCompatibilidadeAmbiente();

  (async function loadScripts() {
    try {
      const response = await fetch('scripts.json');
      const scriptList = await response.json();

      if (Array.isArray(scriptList)) {
        for (const scriptName of scriptList) {
          const script = document.createElement('script');
          script.src = `scripts/${scriptName}`;
          script.async = false; // Garante que a ordem seja mantida
          document.head.appendChild(script);
        }
      } else {
        console.error('Formato inválido no scripts.json');
      }
    } catch (error) {
      console.error('Erro ao carregar scripts:', error);
    }
  })();

const posicoesJanelas = {};
let rebootCount = Number(localStorage.getItem("rebootCount")) || 0;

function mostrarMensagem(texto) {
  const msg = document.getElementById("notificacao");
  msg.textContent = texto;
  msg.style.display = "block";
  clearTimeout(msg.timer);
  msg.timer = setTimeout(() => {
    msg.style.display = "none";
  }, 2000);
}

// Verifica se o iframe carregou corretamente, senão troca por BSOD
document.getElementById("homeIframe").addEventListener("error", () => {
  document.getElementById("homeIframe").src = "bsod.html";
});

document.getElementById("homeIframe").addEventListener("load", () => {
  const iframe = document.getElementById("homeIframe");
  try {
    const test = iframe.contentWindow.document;
    // se carregar bem, zera contagem de reboot
    if (!iframe.src.includes("bsod.html")) rebootCount = 0;
  } catch (e) {
    iframe.src = "bsod.html";
  }
});

// Mensagens recebidas
window.addEventListener("message", (e) => {
  if (e.data === "reboot") {
    rebootCount++;
    localStorage.setItem("rebootCount", rebootCount);
    if (rebootCount >= 4) {
      document.getElementById("homeIframe").src = "recovery.html";
    } else {
      location.reload();
    }
    return; // garante que não continua avaliando os próximos blocos
  }

  if (e.data.startsWith("abrir ")) {
    const nome = e.data.split(" ")[1];
    const existente = Array.from(document.querySelectorAll(".janela")).find(j => {
  const titulo = j.querySelector(".titulo")?.textContent;
  return titulo === nome || titulo + ".html" === nome;
});
    if (!existente) {
      criarJanela(nome);
      mostrarMensagem(`Abrindo: ${nome}`);
    } else {
      mostrarMensagem(`Janela já está aberta: ${nome}`);
    }
  }

if (e.data.startsWith("abrir_admin ")) {
  const nome = e.data.split(" ")[1];


  const existente = Array.from(document.querySelectorAll(".janela")).find(j => {
    const titulo = j.querySelector(".titulo")?.textContent;
    return titulo === nome || titulo + ".html" === nome;
  });

  if (!existente) {
    criarJanela(nome, true);
    mostrarMensagem(`Abrindo com privilégios: ${nome}`);
  } else {
    mostrarMensagem(`Janela já está aberta: ${nome}`);
  }
}

  if (e.data.startsWith("recents ")) {
    const nome = e.data.split(" ")[1];
    document.querySelectorAll(".janela").forEach(j => {
      if (j.querySelector(".titulo")?.textContent === nome) {
        j.style.display = "block";
        j.style.zIndex = ++zIndexAtual;
      }
    });
  }

  if (e.data === "fechar_tudo") {
    document.querySelectorAll(".janela").forEach(j => j.remove());
  }

  if (e.data === "desligar") {
    window.location.href = "https://www.google.com";
  }

  if (e.data === "recovery") {
    document.getElementById("homeIframe").src = "recovery.html";
  }

  if (e.data === "BSOD") {
    document.getElementById("homeIframe").src = "bsod.html";
  }

  if (e.data === "installer") {
    document.getElementById("homeIframe").src = "installer/index.html";
  }

if (e.data === "home") {
    document.getElementById("homeIframe").src = "home.html";
  }
});

const area = document.getElementById("areaDeTrabalho");
let zIndexAtual = 10;

// Recarrega posições salvas se existirem
const salvas = localStorage.getItem("posicoesJanelas");
if (salvas) {
  Object.assign(posicoesJanelas, JSON.parse(salvas));
}

function criarJanela(nomeArquivo, isAdmin = false) {
  const existente = Array.from(document.querySelectorAll(".janela")).find(j =>
    j.querySelector(".titulo")?.textContent === nomeArquivo
  );
  if (existente) {
    existente.style.display = "block";
    existente.style.zIndex = ++zIndexAtual;
    return;
  }

  const janela = document.createElement("div");
  janela.className = "janela";
  janela.style.position = "fixed";
  janela.style.zIndex = ++zIndexAtual;

  const pos = posicoesJanelas[nomeArquivo];
  if (pos) {
    janela.style.top = pos.top;
    janela.style.left = pos.left;
    janela.style.transform = "";
  } else {
    janela.style.top = "50%";
    janela.style.left = "50%";
    janela.style.transform = "translate(-50%, -50%)";
    requestAnimationFrame(() => {
      const rect = janela.getBoundingClientRect();
      janela.style.top = rect.top + "px";
      janela.style.left = rect.left + "px";
      janela.style.transform = "";
    });
  }

  const barra = document.createElement("div");
  barra.className = "barra";

  const titulo = document.createElement("div");
  titulo.className = "titulo";
  titulo.textContent = limparNome(nomeArquivo);

  const icones = document.createElement("div");
  icones.className = "icones";

  const fecharBtn = document.createElement("img");
  fecharBtn.src = "imgs/x.png";
  fecharBtn.onclick = () => {
    posicoesJanelas[nomeArquivo] = {
      top: janela.style.top,
      left: janela.style.left
    };
    localStorage.setItem("posicoesJanelas", JSON.stringify(posicoesJanelas));
    janela.remove();
  };

  const fullBtn = document.createElement("img");
  fullBtn.src = "imgs/full.png";
  let full = false, original = {};
  fullBtn.onclick = () => {
    if (!full) {
      original = {
        top: janela.style.top,
        left: janela.style.left,
        width: janela.style.width,
        height: janela.style.height
      };
      Object.assign(janela.style, {
        top: "0", left: "0", width: "100%", height: "100%"
      });
      full = true;
    } else {
      Object.assign(janela.style, original);
      full = false;
    }
  };

  const barBtn = document.createElement("img");
  barBtn.src = "imgs/bar.png";
  barBtn.onclick = () => {
    janela.style.display = "none";
    document.getElementById("homeIframe").contentWindow.postMessage("recents " + nomeArquivo, "*");
  };

  icones.append(fecharBtn, fullBtn, barBtn);
  barra.append(titulo, icones);
  janela.appendChild(barra);

  const conteudo = document.createElement("div");
  conteudo.className = "conteudo";

  const iframe = document.createElement("iframe");
  iframe.src = "apps/" + nomeArquivo;
  conteudo.appendChild(iframe);
  janela.appendChild(conteudo);


if (!isAdmin) {
  // Insere código de sandbox extra
  iframe.sandbox = "allow-scripts allow-same-origin";
  // Nota: restringe bastante — bloqueia window.open, document.write, etc.
}

  const alca = document.createElement("div");
  alca.className = "alca-resize";
  janela.appendChild(alca);

  alca.addEventListener("touchstart", iniciarResizeMobile, { passive: false });
  alca.addEventListener("mousedown", iniciarResizeDesktop);
  document.body.appendChild(janela);
  ativarMovimento(janela, barra); 
janela.style.top = "50px";
janela.style.left = "50px";
janela.style.transform = ""; 
}


function ativarMovimento(janela, barra) {
  let movendo = false, offsetX, offsetY;
  barra.addEventListener("mousedown", (e) => {
    janela.style.transform = "";
    movendo = true;
    const rect = janela.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    function moverMouse(ev) {
      janela.style.left = (ev.clientX - offsetX) + "px";
      janela.style.top = (ev.clientY - offsetY) + "px";
    }

    function soltarMouse() {
      movendo = false;
      posicoesJanelas[janela.querySelector(".titulo").textContent] = {
        top: janela.style.top,
        left: janela.style.left
      };
      localStorage.setItem("posicoesJanelas", JSON.stringify(posicoesJanelas));
      document.removeEventListener("mousemove", moverMouse);
      document.removeEventListener("mouseup", soltarMouse);
    }

    document.addEventListener("mousemove", moverMouse);
    document.addEventListener("mouseup", soltarMouse);
  });

  barra.addEventListener("touchstart", (e) => {
    const touch = e.touches[0];
    const rect = janela.getBoundingClientRect();
    offsetX = touch.clientX - rect.left;
    offsetY = touch.clientY - rect.top;
    movendo = true;
  }, { passive: false });

  barra.addEventListener("touchmove", (e) => {
    if (!movendo) return;
    const touch = e.touches[0];
    janela.style.left = (touch.clientX - offsetX) + "px";
    janela.style.top = (touch.clientY - offsetY) + "px";
  }, { passive: false });

  barra.addEventListener("touchend", () => {
    movendo = false;
    posicoesJanelas[janela.querySelector(".titulo").textContent] = {
      top: janela.style.top,
      left: janela.style.left
    };
    localStorage.setItem("posicoesJanelas", JSON.stringify(posicoesJanelas));
  });
}

  // ...

  function iniciarResizeDesktop(e) {
    e.preventDefault();
    const janela = e.currentTarget.parentElement;
    const startX = e.clientX;
    const startY = e.clientY;
    const startW = janela.offsetWidth;
    const startH = janela.offsetHeight;

    function resize(ev) {
      janela.style.width = (startW + ev.clientX - startX) + "px";
      janela.style.height = (startH + ev.clientY - startY) + "px";
    }

    function stop() {
      document.removeEventListener("mousemove", resize);
      document.removeEventListener("mouseup", stop);
    }

    document.addEventListener("mousemove", resize);
    document.addEventListener("mouseup", stop);
  }

  function iniciarResizeMobile(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const janela = e.currentTarget.parentElement;
    const startX = touch.clientX;
    const startY = touch.clientY;
    const startW = janela.offsetWidth;
    const startH = janela.offsetHeight;

    function resize(ev) {
      const t = ev.touches[0];
      janela.style.width = (startW + t.clientX - startX) + "px";
      janela.style.height = (startH + t.clientY - startY) + "px";
    }

    function stop() {
      document.removeEventListener("touchmove", resize);
      document.removeEventListener("touchend", stop);
    }

    document.addEventListener("touchmove", resize, { passive: false });
    document.addEventListener("touchend", stop, { passive: false });
  }

let erroFatalExecutado = false;

// Mapeamento das mensagens de erro e se devem acionar o BSOD
const mensagensErro = {
  1: { msg: "ERR.JS.GLOBAL.ERROR", critico: true },
  2: { msg: "ERR.HOMEIFRAME.NOT.EXIST.DOM", critico: true },
  3: { msg: "ERR.IFRAME.NATIVE.ERROR", critico: true },
  4: { msg: "ERR.HOME.NOT.LOADED", critico: true },
  5: { msg: "ERR.CONFLIT", critico: true }, // ← Erro de teste
  6: { msg: "ERR.FUNCTION.OVERLOADED", critico: false }, // ← Erro de teste
  default: { msg: "ERR.UNKNOWN", critico: true }
};

function fatalError(motivo = 0) {
  if (erroFatalExecutado) return;
  erroFatalExecutado = true;

  const erro = mensagensErro[motivo] || mensagensErro.default;
  console.error(erro.msg);

  if (erro.critico) {
    const iframe = document.getElementById("homeIframe");
    if (iframe) {
      iframe.src = "bsod.html";
    }
  }
}

// 1. Erros globais
window.addEventListener("error", () => fatalError(1));

// 2. DOM carregado
window.addEventListener("DOMContentLoaded", () => {
  const iframe = document.getElementById("homeIframe");
  if (!iframe) return fatalError(2);

  iframe.addEventListener("error", () => fatalError(3));

  setTimeout(() => {
  const src = iframe.getAttribute("src");
  if (!src?.includes("home.html") && !src?.includes("logon.html")) {
    fatalError(4); // ERR.HOME.NOT.LOADED
  }
}, 20006);
});

// 3. Controle de conflito
let controleDeExecucao = false;
function verificarConflito() {
  if (controleDeExecucao) {
    fatalError(5); // teste: conflito detectado
  } else {
    controleDeExecucao = true;
    setTimeout(() => controleDeExecucao = false, 1000);
  }
}

// 4. Controle de sobrecarga
let chamadasCriticas = 0;
function minhaFuncaoCritica() {
  chamadasCriticas++;
  if (chamadasCriticas > 5) {
    fatalError(6); // teste: sobrecarga detectada
    return;
  }

  console.log("Executando função crítica");

  setTimeout(() => chamadasCriticas--, 2000);
}

let volume = 50; // 0 a 100

function mostrarHUDVolume(novoVolume) {
  volume = Math.max(0, Math.min(100, novoVolume));
  const hud = document.getElementById("hudVolume");
  const barra = hud.querySelector(".barra");
  barra.style.width = volume + "%";

  hud.style.display = "block";

  clearTimeout(hud._timer);
  hud._timer = setTimeout(() => {
    hud.style.display = "none";
  }, 1200);
}

// Exemplo de uso:
document.addEventListener("keydown", (e) => {
  if (e.code === "ArrowUp") { // Simula volume +
    mostrarHUDVolume(volume + 10);
  } else if (e.code === "ArrowDown") { // Simula volume -
    mostrarHUDVolume(volume - 10);
  }
});

setInterval(() => {
  const iframes = document.querySelectorAll("iframe[data-app]");
  for (const iframe of iframes) {
    try {
      const win = iframe.contentWindow;
      const doc = win?.document;

      // Tenta acessar algo simples pra ver se está vivo
      const ok = !!doc?.readyState;

      if (!ok) throw new Error("iframe não responde");
    } catch (e) {
      const nome = iframe.getAttribute("data-app") || "desconhecido";
      Notificacao?.mostrar("App encerrado", `"${nome}" foi fechado por falha de execução.`);
      iframe.remove();
    }
  }
}, 8000); // Verifica a cada 8 segundos

function limparNome(caminho) {
  return caminho
    .replace(/\/index\.html$/, '') // remove "/index.html" no fim
    .replace(/\.html$/, '');       // remove ".html" no fim
}
</script>
</body>
</html>