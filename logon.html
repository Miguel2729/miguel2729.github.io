<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>login</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: black;
      color: white;
      overflow: auto;
    }

    body {
      background-image: url('wallpapers/wallpaper17.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .tela-inicial, .logon-container {
      position: absolute;
      width: 100%;
      height: 100%;
      transition: transform 0.6s ease-in-out;
    }

    .tela-inicial {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #hora, #data {
      font-size: 2em;
      margin: 5px;
      text-shadow: 1px 1px 4px black;
    }

    #noticias {
      position: absolute;
      bottom: 40px;
      right: 50px;
      text-align: right;
      font-size: 1em;
      line-height: 1.4;
      max-width: 40%;
      text-shadow: 1px 1px 3px black;
    }

    .logon-container {
      background-image: url('wallpapers/wallpaper17.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 2;
      transform: translateY(100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .user-photo {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid white;
      margin-bottom: 15px;
    }

    .username {
      font-size: 1.5em;
    }

    input[type="password"], button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
    }

    button {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: rgba(255, 255, 255, 0.35);
    }

    .info-horaria {
      position: absolute;
      bottom: 40px;
      left: 50px;
      text-align: left;
      text-shadow: 1px 1px 5px black;
    }

    #hora {
      font-size: 4em;
      line-height: 1.1;
    }

    #data {
      font-size: 1.3em;
      margin-top: 10px;
      opacity: 0.85;
    }

    .user-list {
      position: absolute;
      bottom: 40px;
      left: 50px;
      text-align: left;
      text-shadow: 1px 1px 5px black;
      max-height: 200px;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
    }

    .user-list div {
      padding: 5px 0;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .user-list div:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
  /* Adicione estas novas regras CSS */
    .add-user-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      z-index: 3;
    }
    
    .add-user-btn:hover {
      background-color: rgba(255, 255, 255, 0.35);
    }
    
    .user-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 8px;
      z-index: 10;
      display: none;
    }
    
    .user-form input, .user-form button {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
    }
    
    .user-form-buttons {
      display: flex;
      justify-content: space-between;
    }
    
    .image-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      margin: 10px auto;
      display: block;
    }    
  </style>
</head>
<body>
<div class="tela-inicial" id="tela-inicial">
  <div class="info-horaria">
    <div id="hora"></div>
    <div id="data"></div>
  </div>
  <div id="noticias">Carregando notícias...</div>
</div>

<div class="logon-container" id="logon">
  <img src="user/user_photo.jpg" alt="Foto do usuário" class="user-photo">
  <div class="username" id="username">Usuário</div>
  <div id="input-area"></div>
  <div class="user-list" id="user-list">Carregando usuários...</div>
</div>

<button class="add-user-btn" id="addUserBtn">+ Adicionar Usuário</button>

<!-- Adicione este formulário -->
<div class="user-form" id="userForm">
  <h3 style="text-align: center; margin-top: 0;">Adicionar Novo Usuário</h3>
  <img src="user/user_photo.jpg" alt="Preview" class="image-preview" id="imagePreview">
  <input type="file" id="userPhoto" accept="image/*">
  <input type="text" id="newUserName" placeholder="Nome do usuário">
  <input type="password" id="newUserPassword" placeholder="Senha (opcional)">
  <div class="user-form-buttons">
    <button onclick="document.getElementById('userForm').style.display = 'none'">Cancelar</button>
    <button onclick="saveNewUser()">Salvar</button>
  </div>
</div>
<script>

  // Relógio e data
  function atualizarHora() {
    const agora = new Date();
    const hora = agora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const data = agora.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    document.getElementById('hora').textContent = hora;
    document.getElementById('data').textContent = data.charAt(0).toUpperCase() + data.slice(1);
  }
  setInterval(atualizarHora, 1000);
  atualizarHora();

  // Notícias (NewsAPI) — versão aprimorada
  const apiKey = '79f65cf94e144e8c9e3d73ce5e01b164';
  fetch(`https://newsapi.org/v2/top-headlines?country=br&pageSize=5&apiKey=${apiKey}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok" && Array.isArray(data.articles) && data.articles.length > 0) {
        const titulos = data.articles
          .map(a => a.title?.trim())
          .filter(Boolean)
          .map(t => `• ${t}`)
          .join('<br>');
        document.getElementById('noticias').innerHTML = titulos;
      } else {
        document.getElementById('noticias').textContent = 'Nenhuma notícia disponível no momento.';
      }
    })
    .catch(() => {
      document.getElementById('noticias').textContent = 'Falha ao carregar as manchetes.';
    });

  // Deslizar para cima
  let startY = 0;
  document.addEventListener('touchstart', e => startY = e.touches[0].clientY);
  document.addEventListener('touchend', e => {
    if (startY - e.changedTouches[0].clientY > 100) mostrarLogon();
  });
  document.addEventListener('wheel', e => {
    if (e.deltaY < -100) mostrarLogon();
  });

  function mostrarLogon() {
    document.getElementById('tela-inicial').style.transform = 'translateY(-100%)';
    document.getElementById('logon').style.transform = 'translateY(0%)';
  }

  // Carregar lista de usuários
  fetch('users.json')
    .then(res => res.json())
    .then(users => {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';
      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.textContent = user.name;
        userDiv.onclick = () => selectUser(user.folder);
        userList.appendChild(userDiv);
      });
    })
    .catch(() => {
      document.getElementById('user-list').textContent = 'Erro ao carregar usuários';
    });

  function selectUser(userFolder) {
    // Atualizar a interface com os dados do usuário selecionado
    fetch(`users/${userFolder}/user_name.txt`)
      .then(res => res.ok ? res.text() : Promise.reject())
      .then(name => {
        document.getElementById('username').textContent = (name || 'Usuário').trim();
        document.querySelector('.user-photo').src = `users/${userFolder}/user_photo.jpg`;
        
        return fetch(`users/${userFolder}/password.txt`);
      })
      .then(res => res.ok ? res.text() : Promise.reject())
      .then(text => {
        const password = (text || '').trim();
        const inputArea = document.getElementById('input-area');
        
        if (!password) {
          inputArea.innerHTML = `<button onclick="login('${userFolder}')">Entrar</button>`;
        } else {
          inputArea.innerHTML = `
            <input type="password" id="senha" placeholder="Senha">
            <br>
            <button onclick="verificarSenha('${password}', '${userFolder}')">Entrar</button>`;
        }
      })
      .catch(() => {
        document.getElementById('input-area').innerHTML = `<button onclick="login('${userFolder}')">Entrar</button>`;
      });
  }

  function verificarSenha(senhaCorreta, userFolder) {
    const entrada = document.getElementById('senha').value;
    if (entrada === senhaCorreta) {
      login(userFolder);
    } else { 
      alert('Senha incorreta');
    }
  }

  function login(userFolder) {
    try {
      if (window.parent !== window) {
        // Envia o comando para abrir o admin e depois os comandos simultâneos
        window.parent.postMessage("abrir_admin logon-startup.html", "*");
        
        setTimeout(() => {
          // Envia ambos os comandos ao mesmo tempo
          window.parent.postMessage(`user-selected: ${userFolder}`, "*");
          window.parent.postMessage("home", "*");
        }, 2000);
      }
    } catch {
      // silencioso
    }
  }

  // Nome do usuário padrão (caso não selecione nenhum)
  const usernameEl = document.getElementById('username');
  const inputArea = document.getElementById('input-area');

  try {
    fetch('user/user_name.txt')
      .then(res => res.ok ? res.text() : Promise.reject())
      .then(name => usernameEl.textContent = (name || 'Usuário').trim())
      .catch(() => usernameEl.textContent = 'Usuário');
  } catch {
    usernameEl.textContent = 'Usuário';
  }

  // Senha padrão (caso não selecione nenhum usuário)
  try {
    fetch('user/password.txt')
      .then(res => res.ok ? res.text() : Promise.reject())
      .then(text => {
        const password = (text || '').trim();
        if (!password) {
          inputArea.innerHTML = `<button onclick="login('user')">Entrar</button>`;
        } else {
          inputArea.innerHTML = `
            <input type="password" id="senha" placeholder="Senha">
            <br>
            <button onclick="verificarSenha('${password}', 'user')">Entrar</button>`;
        }
      })
      .catch(() => inputArea.innerHTML = '<button onclick="login(\'user\')">Entrar</button>');
  } catch {
    inputArea.innerHTML = '<button onclick="login(\'user\')">Entrar</button>';
  }
  
    // Adicione estas novas funções
  document.getElementById('addUserBtn').addEventListener('click', function() {
    document.getElementById('userForm').style.display = 'block';
    document.getElementById('imagePreview').src = 'user/user_photo.jpg';
  });

  document.getElementById('userPhoto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('imagePreview').src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  function saveNewUser() {
    const name = document.getElementById('newUserName').value.trim();
    if (!name) {
      alert('Por favor, insira um nome para o usuário');
      return;
    }

    const password = document.getElementById('newUserPassword').value.trim();
    const fileInput = document.getElementById('userPhoto');
    const imagePreview = document.getElementById('imagePreview');
    
    let photoBase64 = '';
    if (fileInput.files[0]) {
      // Se uma nova imagem foi selecionada, usamos ela
      const reader = new FileReader();
      reader.onload = function(event) {
        photoBase64 = event.target.result.split(',')[1];
        saveUserToStorage(name, password, photoBase64);
      };
      reader.readAsDataURL(fileInput.files[0]);
    } else {
      // Se não, usamos a imagem padrão
      fetch('user/user_photo.jpg')
        .then(response => response.blob())
        .then(blob => {
          const reader = new FileReader();
          reader.onload = function(event) {
            photoBase64 = event.target.result.split(',')[1];
            saveUserToStorage(name, password, photoBase64);
          };
          reader.readAsDataURL(blob);
        })
        .catch(() => {
          // Se não conseguir carregar a imagem padrão, salva sem foto
          saveUserToStorage(name, password, '');
        });
    }
  }

function saveUserToStorage(name, password, photoBase64) {
    // Gera um ID único para o usuário
    const userId = 'custom_' + Date.now();
    
    // Salva no localStorage
    const customUser = {
      id: userId,
      name: name,
      password: password,
      photo: photoBase64,
      timestamp: new Date().toISOString()
    };
    
    // Obtém usuários existentes ou cria um novo array (CORREÇÃO APLICADA AQUI)
    const existingUsers = JSON.parse(localStorage.getItem('customUsers') || '[]');
    existingUsers.push(customUser);
    localStorage.setItem('customUsers', JSON.stringify(existingUsers));
    
    // Atualiza a lista de usuários
    updateUserList();
    
    // Fecha o formulário
    document.getElementById('userForm').style.display = 'none';
    alert('Usuário criado com sucesso!');
}

  function updateUserList() {
    // Carrega usuários do localStorage
    const customUsers = JSON.parse(localStorage.getItem('customUsers')) || [];
    
    // Carrega usuários do JSON (existente)
    fetch('users.json')
      .then(res => res.json())
      .then(serverUsers => {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        
        // Adiciona usuários do servidor primeiro
        serverUsers.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.textContent = user.name;
          userDiv.onclick = () => selectUser(user.folder);
          userList.appendChild(userDiv);
        });
        
        // Adiciona usuários customizados
        customUsers.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.textContent = user.name + ' (local)';
          userDiv.onclick = () => selectCustomUser(user);
          userList.appendChild(userDiv);
        });
      })
      .catch(() => {
        // Se falhar ao carregar users.json, mostra apenas os customizados
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        
        customUsers.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.textContent = user.name + ' (local)';
          userDiv.onclick = () => selectCustomUser(user);
          userList.appendChild(userDiv);
        });
        
        if (customUsers.length === 0) {
          userList.textContent = 'Nenhum usuário disponível';
        }
      });
  }

  function selectCustomUser(user) {
    document.getElementById('username').textContent = user.name;
    
    // Define a foto (se existir)
    if (user.photo) {
      document.querySelector('.user-photo').src = 'data:image/jpeg;base64,' + user.photo;
    } else {
      document.querySelector('.user-photo').src = 'user/user_photo.jpg';
    }
    
    const inputArea = document.getElementById('input-area');
    if (!user.password) {
      inputArea.innerHTML = `<button onclick="loginCustomUser('${user.id}')">Entrar</button>`;
    } else {
      inputArea.innerHTML = `
        <input type="password" id="senha" placeholder="Senha">
        <br>
        <button onclick="verifyCustomPassword('${user.id}', '${user.password}')">Entrar</button>`;
    }
  }

  function verifyCustomPassword(userId, correctPassword) {
    const enteredPassword = document.getElementById('senha').value;
    if (enteredPassword === correctPassword) {
      loginCustomUser(userId);
    } else {
      alert('Senha incorreta');
    }
  }

function loginCustomUser(userId) {
    const customUsers = JSON.parse(localStorage.getItem('customUsers')) || [];
    const user = customUsers.find(u => u.id === userId);
    
    if (!user) {
        alert('Usuário não encontrado');
        return;
    }
    
    try {
        if (window.parent !== window) {
            console.log("Enviando comando para abrir logon-startup.html");
            window.parent.postMessage("abrir_admin logon-startup.html", "*");
            
            setTimeout(() => {
                console.log("Enviando mensagens de login após 2 segundos");
                const photoData = user.photo ? `photo=${user.photo}` : 'photo=';
                const nameData = `name=${user.name}`;
                
                // Envia em formato padronizado
                const userData = `custom-user-selected: ${photoData} ${nameData}`;
                console.log("Enviando:", userData);
                window.parent.postMessage(userData, "*");
                
                console.log("Enviando comando 'home'");
                window.parent.postMessage("home", "*");
            }, 2000);
        }
    } catch (error) {
        console.error("Erro no loginCustomUser:", error);
    }
}
  // Atualiza a lista de usuários quando a página carrega
  updateUserList();
</script>
</body>
</html>
