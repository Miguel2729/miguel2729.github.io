<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicativos da Comunidade</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; min-height: calc(100vh - 40px); }
        header { background: linear-gradient(135deg, #0078d7 0%, #005a9e 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .logo { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .logo-icon { width: 50px; height: 50px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #0078d7; font-size: 24px; }
        .user-info { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0078d7; font-weight: bold; }
        nav { display: flex; background: #f8f9fa; padding: 0 30px; border-bottom: 1px solid #e0e0e0; }
        .nav-button { padding: 15px 25px; background: none; border: none; font-size: 1em; color: #666; cursor: pointer; transition: all 0.3s; }
        .nav-button:hover { color: #0078d7; background: rgba(0,120,215,0.1); }
        .nav-button.active { color: #0078d7; font-weight: 600; border-bottom: 3px solid #0078d7; margin-bottom: -2px; }
        .main-content { padding: 30px; min-height: 600px; }
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .auth-tabs { display: flex; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; }
        .auth-tab { flex: 1; padding: 15px; text-align: center; background: none; border: none; font-size: 1.1em; cursor: pointer; transition: all 0.3s; }
        .auth-tab.active { color: #0078d7; font-weight: 600; border-bottom: 3px solid #0078d7; margin-bottom: -2px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: all 0.3s; }
        .form-group input:focus { outline: none; border-color: #0078d7; box-shadow: 0 0 0 3px rgba(0,120,215,0.1); }
        .auth-button { width: 100%; padding: 15px; background: linear-gradient(135deg, #0078d7 0%, #005a9e 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .auth-button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,120,215,0.3); }
        .controls { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 300px; }
        .search-box input { width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 50px; font-size: 1em; background: #f8f9fa; }
        .filter-select { padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 50px; background: white; font-size: 1em; min-width: 200px; }
        .upload-button { padding: 12px 30px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 50px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .upload-button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(40,167,69,0.3); }
        .apps-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .app-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: all 0.3s; border: 1px solid #e0e0e0; }
        .app-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .app-icon { height: 150px; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3em; }
        .app-icon img { width: 80px; height: 80px; object-fit: contain; }
        .app-content { padding: 20px; }
        .app-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .app-title { font-size: 1.3em; font-weight: 600; color: #333; }
        .app-rating { background: #ffc107; color: white; padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.9em; }
        .app-description { color: #666; font-size: 0.95em; line-height: 1.5; margin-bottom: 15px; height: 60px; overflow: hidden; }
        .app-meta { display: flex; justify-content: space-between; color: #888; font-size: 0.85em; margin-bottom: 20px; }
        .app-actions { display: flex; gap: 10px; }
        .action-button { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .download-button { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; }
        .open-button { background: linear-gradient(135deg, #0078d7 0%, #005a9e 100%); color: white; }
        .delete-button { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .action-button:hover { opacity: 0.9; transform: translateY(-2px); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5em; font-weight: 600; color: #333; }
        .close-modal { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; }
        .upload-form input, .upload-form textarea, .upload-form select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .upload-form textarea { min-height: 100px; resize: vertical; }
        .file-input { border: 2px dashed #ddd; padding: 30px; text-align: center; cursor: pointer; margin-bottom: 15px; }
        .file-input:hover { border-color: #0078d7; }
        .stars { display: flex; gap: 5px; margin: 10px 0; }
        .star { font-size: 1.5em; color: #ddd; cursor: pointer; transition: color 0.2s; }
        .star.active { color: #ffc107; }
        @media (max-width: 768px) {
            .container { border-radius: 10px; }
            header { padding: 20px; }
            .user-info { position: static; margin-top: 15px; justify-content: center; }
            nav { flex-wrap: wrap; padding: 0; }
            .nav-button { flex: 1 0 50%; }
            .controls { flex-direction: column; }
            .search-box { min-width: 100%; }
            .apps-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üíé</div>
                <div>Aplicativos da Comunidade</div>
            </div>
            <div class="subtitle">Descubra, baixe e compartilhe aplicativos incr√≠veis</div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">Usu√°rio</div>
                    <div style="font-size: 0.8em; opacity: 0.8;" id="userEmail"></div>
                </div>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 15px; background: rgba(255,255,255,0.3); border: none; border-radius: 5px; color: white; cursor: pointer;">
                    Sair
                </button>
            </div>
        </header>

        <nav>
            <button class="nav-button active" onclick="showSection('explore')">Explorar</button>
            <button class="nav-button" onclick="showSection('myApps')">Meus Apps</button>
            <button class="nav-button" onclick="showSection('upload')">Enviar App</button>
            <button class="nav-button" onclick="showSection('admin')" id="adminTab" style="display: none;">Admin</button>
        </nav>

        <div class="main-content">
            <!-- Se√ß√£o de Login -->
            <div id="loginSection" class="auth-container">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="showAuthTab('register')">Registro</button>
                </div>
                
                <div id="loginForm">
                    <div class="form-group">
                        <label>Nome de usu√°rio</label>
                        <input type="text" id="loginUsername" placeholder="Seu nome de usu√°rio">
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" placeholder="Sua senha">
                    </div>
                    <button class="auth-button" onclick="login()">Entrar</button>
                </div>

                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label>Nome de usu√°rio</label>
                        <input type="text" id="regUsername" placeholder="Escolha um nome de usu√°rio">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="regEmail" placeholder="Seu email">
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="regPassword" placeholder="Crie uma senha">
                    </div>
                    <button class="auth-button" onclick="register()">Criar Conta</button>
                </div>
            </div>

            <!-- Se√ß√£o de Apps (ap√≥s login) -->
            <div id="appSections" style="display: none;">
                <!-- Explorar -->
                <div id="exploreSection">
                    <div class="controls">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Buscar aplicativos..." oninput="searchApps()">
                        </div>
                        <select class="filter-select" id="categoryFilter" onchange="filterApps()">
                            <option value="all">Todas as categorias</option>
                            <option value="utility">Utilit√°rios</option>
                            <option value="game">Jogos</option>
                            <option value="tool">Ferramentas</option>
                            <option value="educational">Educacional</option>
                            <option value="entertainment">Entretenimento</option>
                        </select>
                        <select class="filter-select" id="sortFilter" onchange="sortApps()">
                            <option value="download_count">Mais baixados</option>
                            <option value="rating">Melhor avaliados</option>
                            <option value="newest">Mais recentes</option>
                        </select>
                    </div>
                    <div class="apps-grid" id="appsGrid">
                        <!-- Apps ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- Meus Apps -->
                <div id="myAppsSection" style="display: none;">
                    <h2 style="margin-bottom: 20px;">Meus Apps Instalados</h2>
                    <div class="apps-grid" id="myAppsGrid">
                        <!-- Apps instalados aparecer√£o aqui -->
                    </div>
                </div>

                <!-- Upload -->
                <div id="uploadSection" style="display: none;">
                    <h2 style="margin-bottom: 20px;">Enviar Novo App</h2>
                    <div class="upload-form">
                        <input type="text" id="appName" placeholder="Nome do aplicativo *">
                        <textarea id="appDescription" placeholder="Descri√ß√£o do aplicativo *"></textarea>
                        <input type="text" id="appVersion" placeholder="Vers√£o (ex: 1.0.0)" value="1.0.0">
                        <select id="appCategory">
                            <option value="utility">Utilit√°rio</option>
                            <option value="game">Jogo</option>
                            <option value="tool">Ferramenta</option>
                            <option value="educational">Educacional</option>
                            <option value="entertainment">Entretenimento</option>
                        </select>
                        <input type="text" id="appTags" placeholder="Tags (separadas por v√≠rgula)">
                        
                        <div class="file-input" onclick="document.getElementById('appFile').click()">
                            <div>üìÅ Clique para selecionar o arquivo HTML do app *</div>
                            <div style="font-size: 0.9em; color: #666;" id="appFileName">Nenhum arquivo selecionado</div>
                        </div>
                        <input type="file" id="appFile" accept=".html" style="display: none;" onchange="updateFileName()">
                        
                        <div class="file-input" onclick="document.getElementById('iconFile').click()">
                            <div>üñºÔ∏è Clique para selecionar √≠cone (opcional)</div>
                            <div style="font-size: 0.9em; color: #666;" id="iconFileName">Nenhum arquivo selecionado</div>
                        </div>
                        <input type="file" id="iconFile" accept=".png,.jpg,.jpeg" style="display: none;" onchange="updateIconName()">
                        
                        <button class="upload-button" style="width: 100%; margin-top: 20px;" onclick="uploadApp()">
                            Enviar Aplicativo
                        </button>
                    </div>
                </div>

                <!-- Admin -->
                <div id="adminSection" style="display: none;">
                    <h2 style="margin-bottom: 20px;">Aprova√ß√£o de Apps</h2>
                    <div id="pendingApps">
                        <!-- Apps pendentes aparecer√£o aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal-overlay" id="detailsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalAppName">App Name</div>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalContent">
                <!-- Conte√∫do do modal ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <script>
// ============ CONFIGURA√á√ÉO ============
// COLE AQUI SUA URL DO RENDER (adicione /api no final)
const BACKEND_URL = 'https://netos-community.onrender.com/api';

// Estado global
let currentUser = null;
let allApps = [];
let currentSection = 'explore';

// ============ FUN√á√ïES PRINCIPAIS ============

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    checkLogin();
    testBackendConnection();
});

// Testa conex√£o com backend
async function testBackendConnection() {
    try {
        const response = await fetch(`${BACKEND_URL}/health`);
        if (response.ok) {
            console.log('‚úÖ Backend conectado!');
        } else {
            console.error('‚ùå Backend offline');
            alert('Backend n√£o est√° respondendo. Verifique se o servidor est√° online.');
        }
    } catch (error) {
        console.error('‚ùå Erro de conex√£o:', error);
    }
}

// ============ AUTENTICA√á√ÉO ============

async function login() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        alert('Por favor, preencha todos os campos');
        return;
    }
    
    try {
        const response = await fetch(`${BACKEND_URL}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            localStorage.setItem('community_user', JSON.stringify(currentUser));
            showAppSections();
            loadApps();
            alert('Login realizado com sucesso!');
        } else {
            alert(data.error || 'Erro no login');
        }
    } catch (error) {
        alert('Erro de conex√£o com o servidor');
    }
}

async function register() {
    const username = document.getElementById('regUsername').value;
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    
    if (!username || !email || !password) {
        alert('Por favor, preencha todos os campos');
        return;
    }
    
    try {
        const response = await fetch(`${BACKEND_URL}/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, email, password})
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Conta criada com sucesso! Fa√ßa login.');
            showAuthTab('login');
        } else {
            alert(data.error || 'Erro no registro');
        }
    } catch (error) {
        alert('Erro de conex√£o com o servidor');
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('community_user');
    checkLogin();
    alert('Logout realizado!');
}

function checkLogin() {
    const savedUser = localStorage.getItem('community_user');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showAppSections();
        loadApps();
    } else {
        showLoginSection();
    }
}

// ============ INTERFACE ============

function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
    event.target.classList.add('active');
}

function showSection(section) {
    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('#appSections > div').forEach(div => {
        div.style.display = 'none';
    });
    
    document.getElementById(`${section}Section`).style.display = 'block';
    currentSection = section;
    
    if (section === 'explore') {
        loadApps();
    } else if (section === 'myApps') {
        loadMyApps();
    } else if (section === 'admin' && currentUser?.is_admin) {
        loadPendingApps();
    }
}

function showLoginSection() {
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('appSections').style.display = 'none';
    document.getElementById('userInfo').style.display = 'none';
}

function showAppSections() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('appSections').style.display = 'block';
    document.getElementById('userInfo').style.display = 'flex';
    
    document.getElementById('userName').textContent = currentUser.username;
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
    
    if (currentUser.is_admin) {
        document.getElementById('adminTab').style.display = 'block';
    }
}

// ============ APPS ============

async function loadApps() {
    try {
        const response = await fetch(`${BACKEND_URL}/apps`);
        allApps = await response.json();
        displayApps(allApps);
    } catch (error) {
        console.error('Erro ao carregar apps:', error);
        document.getElementById('appsGrid').innerHTML = '<p style="text-align: center; color: #666;">Erro ao carregar aplicativos</p>';
    }
}

function displayApps(apps) {
    const grid = document.getElementById('appsGrid');
    grid.innerHTML = '';
    
    if (apps.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">Nenhum aplicativo encontrado</p>';
        return;
    }
    
    apps.forEach(app => {
        const appElement = document.createElement('div');
        appElement.className = 'app-card';
        appElement.innerHTML = `
            <div class="app-icon">
                ${app.icon_path ? `<img src="${app.icon_path}" alt="${app.name}">` : 'üì±'}
            </div>
            <div class="app-content">
                <div class="app-header">
                    <div class="app-title">${app.name}</div>
                    <div class="app-rating">‚≠ê ${app.rating?.toFixed(1) || '0.0'}</div>
                </div>
                <div class="app-description">${app.description}</div>
                <div class="app-meta">
                    <div>üë§ ${app.author}</div>
                    <div>‚¨áÔ∏è ${app.download_count || 0}</div>
                </div>
                <div class="app-actions">
                    <button class="action-button download-button" onclick="downloadApp('${app.id}')">Baixar</button>
                    <button class="action-button open-button" onclick="openApp('${app.id}')">Abrir</button>
                </div>
            </div>
        `;
        grid.appendChild(appElement);
    });
}

function searchApps() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filteredApps = allApps.filter(app => 
        app.name.toLowerCase().includes(searchTerm) ||
        app.description.toLowerCase().includes(searchTerm) ||
        (app.tags && app.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
    );
    displayApps(filteredApps);
}

function filterApps() {
    const category = document.getElementById('categoryFilter').value;
    let filteredApps = allApps;
    
    if (category !== 'all') {
        filteredApps = allApps.filter(app => app.category === category);
    }
    
    displayApps(filteredApps);
}

// ============ DOWNLOAD E ABERTURA ============

async function downloadApp(appId) {
    if (!currentUser) {
        alert('Fa√ßa login para baixar aplicativos');
        return;
    }
    
    try {
        // Encontrar o app primeiro
        const app = allApps.find(a => a.id === appId);
        if (!app) {
            alert('App n√£o encontrado');
            return;
        }
        
        // Criar conte√∫do HTML b√°sico
        const appContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>${app.name}</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
        .app-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #0078d7; margin-bottom: 10px; }
        .meta { color: #666; margin-bottom: 20px; }
        .content { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>${app.name}</h1>
        <div class="meta">
            <p><strong>Autor:</strong> ${app.author}</p>
            <p><strong>Vers√£o:</strong> ${app.version || '1.0.0'}</p>
            <p><strong>Categoria:</strong> ${app.category || 'Utilit√°rio'}</p>
        </div>
        <p>${app.description}</p>
        <div class="content">
            <h3>üéØ Conte√∫do do Aplicativo</h3>
            <p>Este √© um aplicativo da comunidade NetOS.</p>
            <p>Para funcionalidades completas, execute dentro do sistema NetOS.</p>
            <p><strong>Instalado em:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
    </div>
</body>
</html>`;
        
        // Criar blob e fazer download
        const blob = new Blob([appContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${app.name.replace(/\s+/g, '_')}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`Aplicativo "${app.name}" baixado com sucesso!`);
        
        // Registrar download no backend (se tiver essa fun√ß√£o)
        try {
            await fetch(`${BACKEND_URL}/apps/${appId}/download`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: currentUser.id})
            });
        } catch (e) {
            console.log('Download n√£o registrado no servidor:', e);
        }
        
    } catch (error) {
        console.error('Erro no download:', error);
        alert('Erro ao baixar aplicativo');
    }
}

function openApp(appId) {
    const app = allApps.find(a => a.id === appId);
    if (app) {
        const appContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>${app.name}</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .app-header { margin-bottom: 20px; padding: 20px; background: #0078d7; color: white; border-radius: 10px; }
        .app-content { padding: 20px; background: #f8f9fa; border-radius: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>${app.name}</h1>
        <p>${app.description}</p>
        <p><small>Por ${app.author} | Vers√£o ${app.version || '1.0.0'} | ${app.category || 'Utilit√°rio'}</small></p>
    </div>
    <div class="app-content">
        <h3>üöÄ Aplicativo da Comunidade</h3>
        <p>Este aplicativo est√° sendo executado dentro do NetOS.</p>
        <p><strong>Recursos dispon√≠veis:</strong></p>
        <ul>
            <li>Interface otimizada para desktop virtual</li>
            <li>Integra√ß√£o com sistema de permiss√µes</li>
            <li>Acesso aos recursos do NetOS</li>
        </ul>
        <div style="margin-top: 30px; text-align: center;">
            <button onclick="parent.postMessage('install ${appId}', '*')" 
                    style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                üì• Instalar no NetOS
            </button>
            <button onclick="window.close()" 
                    style="margin-left: 10px; padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                ‚úñÔ∏è Fechar
            </button>
        </div>
    </div>
</body>
</html>`;
        
        window.parent.postMessage(`abrir_custom ${app.name} seguro ${appContent}`, '*');
    }
}

// ============ MEUS APPS ============

async function loadMyApps() {
    // Carregar apps instalados do localStorage
    const installedApps = JSON.parse(localStorage.getItem('installed_apps') || '[]');
    const grid = document.getElementById('myAppsGrid');
    grid.innerHTML = '';
    
    if (installedApps.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">Voc√™ n√£o tem aplicativos instalados</p>';
        return;
    }
    
    installedApps.forEach(app => {
        const appElement = document.createElement('div');
        appElement.className = 'app-card';
        appElement.innerHTML = `
            <div class="app-icon">üì±</div>
            <div class="app-content">
                <div class="app-title">${app.name}</div>
                <div class="app-description">${app.description || 'App da comunidade'}</div>
                <div class="app-meta">
                    <div>Vers√£o ${app.version || '1.0.0'}</div>
                    <div>Instalado em ${new Date(app.installed_at).toLocaleDateString()}</div>
                </div>
                <div class="app-actions">
                    <button class="action-button open-button" onclick="openInstalledApp('${app.id}')">Abrir</button>
                    <button class="action-button delete-button" onclick="uninstallApp('${app.id}')">Desinstalar</button>
                </div>
            </div>
        `;
        grid.appendChild(appElement);
    });
}

// ============ UPLOAD ============

function updateFileName() {
    const fileInput = document.getElementById('appFile');
    const fileName = document.getElementById('appFileName');
    fileName.textContent = fileInput.files[0]?.name || 'Nenhum arquivo selecionado';
}

function updateIconName() {
    const fileInput = document.getElementById('iconFile');
    const fileName = document.getElementById('iconFileName');
    fileName.textContent = fileInput.files[0]?.name || 'Nenhum arquivo selecionado';
}

async function uploadApp() {
    if (!currentUser) {
        alert('Fa√ßa login para enviar aplicativos');
        return;
    }
    
    const appName = document.getElementById('appName').value;
    const description = document.getElementById('appDescription').value;
    const version = document.getElementById('appVersion').value;
    const category = document.getElementById('appCategory').value;
    const tags = document.getElementById('appTags').value;
    const appFile = document.getElementById('appFile').files[0];
    const iconFile = document.getElementById('iconFile').files[0];
    
    if (!appName || !description || !appFile) {
        alert('Preencha todos os campos obrigat√≥rios (*)');
        return;
    }
    
    const formData = new FormData();
    formData.append('user_id', currentUser.id);
    formData.append('name', appName);
    formData.append('description', description);
    formData.append('version', version);
    formData.append('category', category);
    formData.append('tags', tags);
    formData.append('app_file', appFile);
    if (iconFile) {
        formData.append('icon_file', iconFile);
    }
    
    try {
        const response = await fetch(`${BACKEND_URL}/apps/upload`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(data.message);
            // Limpar formul√°rio
            document.getElementById('appName').value = '';
            document.getElementById('appDescription').value = '';
            document.getElementById('appTags').value = '';
            document.getElementById('appFile').value = '';
            document.getElementById('iconFile').value = '';
            document.getElementById('appFileName').textContent = 'Nenhum arquivo selecionado';
            document.getElementById('iconFileName').textContent = 'Nenhum arquivo selecionado';
            
            // Recarregar apps
            loadApps();
        } else {
            alert(data.error || 'Erro ao enviar aplicativo');
        }
    } catch (error) {
        console.error('Erro no upload:', error);
        alert('Erro ao enviar aplicativo');
    }
}

// ============ INSTALA√á√ÉO ============

async function installApp(appId) {
    const app = allApps.find(a => a.id === appId);
    if (!app) return;
    
    const installedApps = JSON.parse(localStorage.getItem('installed_apps') || '[]');
    
    // Verifica se j√° est√° instalado
    if (installedApps.some(a => a.id === appId)) {
        alert(`${app.name} j√° est√° instalado!`);
        return;
    }
    
    installedApps.push({
        id: app.id,
        name: app.name,
        description: app.description,
        version: app.version || '1.0.0',
        category: app.category,
        installed_at: new Date().toISOString()
    });
    
    localStorage.setItem('installed_apps', JSON.stringify(installedApps));
    alert(`${app.name} instalado com sucesso!`);
    loadMyApps();
}

function uninstallApp(appId) {
    if (!confirm('Desinstalar este aplicativo?')) return;
    
    const installedApps = JSON.parse(localStorage.getItem('installed_apps') || '[]');
    const updatedApps = installedApps.filter(app => app.id !== appId);
    localStorage.setItem('installed_apps', JSON.stringify(updatedApps));
    
    loadMyApps();
    alert('Aplicativo desinstalado!');
}

function openInstalledApp(appId) {
    const installedApps = JSON.parse(localStorage.getItem('installed_apps') || '[]');
    const app = installedApps.find(a => a.id === appId);
    
    if (app) {
        const appContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>${app.name}</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .header { background: linear-gradient(135deg, #0078d7 0%, #005a9e 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }
        .content { padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .info-item { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="header">
        <h1>${app.name}</h1>
        <p>${app.description || 'Aplicativo instalado localmente'}</p>
    </div>
    <div class="content">
        <h3>üìä Informa√ß√µes do App</h3>
        <div class="info">
            <div class="info-item">
                <strong>Vers√£o:</strong> ${app.version || '1.0.0'}
            </div>
            <div class="info-item">
                <strong>Categoria:</strong> ${app.category || 'Utilit√°rio'}
            </div>
            <div class="info-item">
                <strong>Instalado em:</strong> ${new Date(app.installed_at).toLocaleDateString()}
            </div>
            <div class="info-item">
                <strong>ID:</strong> ${app.id.substring(0, 8)}...
            </div>
        </div>
        <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px; border-left: 5px solid #28a745;">
            <h4>üöÄ √Årea do Aplicativo</h4>
            <p>Esta √© a √°rea funcional do aplicativo ${app.name}.</p>
            <p>Como este √© um aplicativo de exemplo, voc√™ pode substituir este conte√∫do pelo c√≥digo real do app.</p>
            <div style="margin-top: 20px;">
                <button onclick="alert('Funcionalidade do app executada!')" style="padding: 10px 20px; background: #0078d7; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Executar Fun√ß√£o
                </button>
                <button onclick="window.close()" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</body>
</html>`;
        
        window.parent.postMessage(`abrir_custom ${app.name} seguro ${appContent}`, '*');
    }
}

// ============ ADMIN ============

async function loadPendingApps() {
    if (!currentUser?.is_admin) return;
    
    try {
        // Esta rota precisa ser implementada no backend
        const response = await fetch(`${BACKEND_URL}/admin/apps/pending`);
        if (!response.ok) {
            document.getElementById('adminSection').innerHTML = '<p style="text-align: center; color: #666;">Funcionalidade admin n√£o implementada no backend</p>';
            return;
        }
        
        const apps = await response.json();
        const container = document.getElementById('pendingApps');
        container.innerHTML = '';
        
        if (apps.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum app pendente</p>';
            return;
        }
        
        apps.forEach(app => {
            const appElement = document.createElement('div');
            appElement.className = 'app-card';
            appElement.innerHTML = `
                <div class="app-content">
                    <div class="app-title">${app.name}</div>
                    <div class="app-description">${app.description}</div>
                    <div class="app-meta">
                        <div>üë§ ${app.author}</div>
                        <div>Enviado em ${new Date(app.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="app-actions">
                        <button class="action-button open-button" onclick="reviewApp('${app.id}')">Revisar</button>
                        <button class="action-button download-button" onclick="approveApp('${app.id}')">Aprovar</button>
                        <button class="action-button delete-button" onclick="rejectApp('${app.id}')">Rejeitar</button>
                    </div>
                </div>
            `;
            container.appendChild(appElement);
        });
    } catch (error) {
        console.error('Erro ao carregar apps pendentes:', error);
        document.getElementById('adminSection').innerHTML = '<p style="text-align: center; color: #666;">Erro ao carregar apps pendentes</p>';
    }
}

// ============ OUVIDOR DE MENSAGENS ============

window.addEventListener('message', (event) => {
    // Instala√ß√£o via mensagem
    if (event.data.startsWith('install ')) {
        const appId = event.data.split(' ')[1];
        installApp(appId);
    }
});

// ============ UTILIT√ÅRIOS ============

function closeModal() {
    document.getElementById('detailsModal').style.display = 'none';
}

// Ordena√ß√£o
async function sortApps() {
    const sortBy = document.getElementById('sortFilter').value;
    try {
        const response = await fetch(`${BACKEND_URL}/apps?sort=${sortBy}`);
        allApps = await response.json();
        displayApps(allApps);
    } catch (error) {
        console.error('Erro ao ordenar apps:', error);
    }
}

// Inicializa√ß√£o final
console.log('üöÄ Aplicativos da Comunidade iniciado!');
console.log('üåê Backend URL:', BACKEND_URL);
    </script>
</body>
</html>