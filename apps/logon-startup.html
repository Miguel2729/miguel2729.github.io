<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Inicialização</title>
  <style>
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: sans-serif;
    }
    #status {
      font-size: 1.2em;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="status">Aguardando seleção de usuário...</div>

  <script>
    window.addEventListener("message", (e) => {
    console.log("Mensagem recebida no logon-startup:", e.data);
    
    // Verifica se a mensagem é "user-selected: <nome>"
    if (e.data.startsWith("user-selected:")) {
        const nome = e.data.split(":")[1].trim();
        console.log("Processando usuário normal:", nome);
        iniciarSessao(nome, false);
    }
    // Verifica se a mensagem é "custom-user-selected: photo=<código base64> name=<nome>"
    else if (e.data.startsWith("custom-user-selected:")) {
        console.log("Processando usuário customizado:", e.data);
        
        // Processa os dados de forma mais robusta
        const parts = e.data.split(/\s+/);
        let photo = '';
        let name = 'Usuário';
        
        parts.forEach(part => {
            if (part.startsWith("photo=")) {
                photo = part.substring(6).trim();
            } else if (part.startsWith("name=")) {
                name = part.substring(5).trim();
            }
        });
        
        console.log("Dados extraídos - photo:", photo ? "[presente]" : "[vazio]", "name:", name);
        iniciarSessao(name, true, photo);
    }
});

function iniciarSessao(nome, isCustom, photo = '') {
    document.getElementById("status").textContent = `Inicializando sessão para ${nome}...`;
    console.log(`Iniciando sessão para ${nome} (custom: ${isCustom})`);

    setTimeout(() => {
        const mensagem = isCustom 
            ? `custom-user: photo=${photo} name=${nome}`
            : `user:${nome}`;
            
        console.log("Enviando para parent:", mensagem);
        parent.postMessage(mensagem, "*");
        
        document.getElementById("status").textContent = `Sessão iniciada: ${nome}`;
        parent.postMessage("fechar logon-startup.html", "*");
    }, 7000);
}
  </script>
</body>
</html>