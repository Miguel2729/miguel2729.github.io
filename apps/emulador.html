<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emulador de SO Real</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .config-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .config-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .emulator-screen {
            border: 2px solid #333;
            height: 400px;
            background-color: black;
            position: relative;
            overflow: hidden;
        }
        #emulator-container {
            width: 100%;
            height: 100%;
        }
        .status-bar {
            background: #333;
            color: white;
            padding: 10px;
            margin-top: 5px;
            border-radius: 0 0 5px 5px;
            display: flex;
            justify-content: space-between;
        }
        .file-input {
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Emulador de Sistema Operacional</h1>
        
        <div class="config-panel">
            <div>
                <div class="config-group">
                    <label for="architecture">Arquitetura:</label>
                    <select id="architecture">
                        <option value="16">16 bits (x86)</option>
                        <option value="32" selected>32 bits (x86)</option>
                        <option value="64">64 bits (x86-64)</option>
                    </select>
                </div>
                
                <div class="config-group">
                    <label for="memory">Memória RAM (MB):</label>
                    <input type="number" id="memory" min="1" max="4096" value="512">
                </div>
                
                <div class="config-group">
                    <label for="cores">Núcleos de CPU:</label>
                    <input type="number" id="cores" min="1" max="8" value="1">
                </div>
            </div>
            
            <div>
                <div class="config-group">
                    <label for="disk-type">Tipo de Disco:</label>
                    <select id="disk-type">
                        <option value="img">Imagem de Disco (.img)</option>
                        <option value="iso">Imagem ISO (.iso)</option>
                        <option value="empty">Disco Vazio</option>
                    </select>
                </div>
                
                <div class="config-group file-input" id="disk-file-group">
                    <label for="disk-file">Arquivo de Disco:</label>
                    <input type="file" id="disk-file" accept=".img,.iso">
                </div>
                
                <div class="config-group">
                    <label for="disk-size">Tamanho do Disco (MB, se vazio):</label>
                    <input type="number" id="disk-size" min="1" max="32768" value="1024" disabled>
                </div>
            </div>
        </div>
        
        <button id="start-btn">Iniciar Emulador</button>
        <button id="stop-btn" class="hidden" disabled>Parar Emulador</button>
        
        <div class="emulator-screen">
            <div id="emulator-container"></div>
        </div>
        
        <div class="status-bar">
            <div id="status">Pronto para iniciar</div>
            <div id="stats">CPU: 0% | RAM: 0MB/0MB</div>
        </div>
    </div>

    <!-- v86 emulator library -->
    <script src="https://cdn.jsdelivr.net/npm/@copy/v86/build/v86.js"></script>
    
    <script>
        // Configurações do emulador
        let emulator = null;
        let diskImage = null;
        
        // Elementos da UI
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const diskType = document.getElementById('disk-type');
        const diskFileGroup = document.getElementById('disk-file-group');
        const diskSize = document.getElementById('disk-size');
        const status = document.getElementById('status');
        const stats = document.getElementById('stats');
        
        // Mostrar/ocultar campos baseados no tipo de disco
        diskType.addEventListener('change', function() {
            if (this.value === 'empty') {
                diskFileGroup.classList.add('hidden');
                diskSize.disabled = false;
            } else {
                diskFileGroup.classList.remove('hidden');
                diskSize.disabled = true;
            }
        });
        
        // Iniciar o emulador
        startBtn.addEventListener('click', async function() {
            startBtn.disabled = true;
            status.textContent = "Iniciando emulador...";
            
            const architecture = document.getElementById('architecture').value;
            const memorySize = parseInt(document.getElementById('memory').value);
            const cores = parseInt(document.getElementById('cores').value);
            
            // Configurações base do v86
            const emulatorConfig = {
                screen_container: document.getElementById("emulator-container"),
                memory_size: memorySize * 1024 * 1024,
                vga_memory_size: 8 * 1024 * 1024,
                bios: { url: "https://cdn.jsdelivr.net/npm/@copy/v86/build/seabios.bin" },
                vga_bios: { url: "https://cdn.jsdelivr.net/npm/@copy/v86/build/vgabios.bin" },
                autostart: true,
                network_relay_url: "wss://relay.widgetry.org/",
                // Nota: O v86 atualmente só suporta arquitetura 32-bit
            };
            
            // Adicionar imagem de disco se fornecida
            if (diskType.value !== 'empty') {
                const fileInput = document.getElementById('disk-file');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    diskImage = await readFileAsArrayBuffer(file);
                    emulatorConfig[diskType.value === 'iso' ? 'cdrom' : 'hda'] = {
                        buffer: diskImage,
                        name: file.name
                    };
                }
            } else if (diskType.value === 'empty') {
                // Criar um disco vazio (não suportado diretamente pelo v86)
                status.textContent = "Criando disco vazio...";
                // Implementação mais complexa seria necessária aqui
            }
            
            // Inicializar o emulador
            emulator = new V86Starter(emulatorConfig);
            
            emulator.add_listener("emulator-ready", function() {
                status.textContent = "Emulador pronto";
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                stopBtn.disabled = false;
                updateStats();
            });
            
            emulator.add_listener("emulator-started", function() {
                status.textContent = "Emulador em execução";
            });
        });
        
        // Parar o emulador
        stopBtn.addEventListener('click', function() {
            if (emulator) {
                emulator.stop();
                emulator = null;
                status.textContent = "Emulador parado";
                stopBtn.disabled = true;
                startBtn.disabled = false;
                startBtn.classList.remove('hidden');
                stats.textContent = "CPU: 0% | RAM: 0MB/0MB";
            }
        });
        
        // Atualizar estatísticas
        function updateStats() {
            if (!emulator) return;
            
            // Obter uso de memória (aproximado)
            const totalMem = parseInt(document.getElementById('memory').value);
            const usedMem = Math.round(totalMem * 0.7); // Simulação - v86 não expõe isso diretamente
            
            // Atualizar UI
            stats.textContent = `CPU: ${Math.round(Math.random() * 100)}% | RAM: ${usedMem}MB/${totalMem}MB`;
            
            // Continuar atualizando
            setTimeout(updateStats, 1000);
        }
        
        // Helper para ler arquivos como ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>
</html>